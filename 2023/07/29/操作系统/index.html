<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta 
    name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta 
    http-equiv="X-UA-Compatible" 
    content="ie=edge">
  <meta 
    name="theme-color" 
    content="#fff" 
    id="theme-color">
  <meta 
    name="description" 
    content="Hexo">
  <link 
    rel="icon" 
    href="/img/website_logo.png">
  <title>æ“ä½œç³»ç»Ÿ</title>
  
    
      <meta 
        property="og:title" 
        content="æ“ä½œç³»ç»Ÿ">
    
    
      <meta 
        property="og:url" 
        content="https://github.com/JKLASDWD/JKLASDWD.github.io/2023/07/29/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/index.html">
    
    
      <meta 
        property="og:img" 
        content="/img/author.png">
    
    
    
      <meta 
        property="og:type" 
        content="article">
      <meta 
        property="og:article:published_time" 
        content="2023-07-29">
      <meta 
        property="og:article:modified_time" 
        content="2023-07-29">
      <meta 
        property="og:article:author" 
        content="JKLASDWD">
      
        
      
    
  
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  <link rel="preload" href="/css/main.css" as="style" >
  
  <link rel="modulepreload" href="//instant.page/5.1.0">
  
  <link rel="stylesheet" href="/css/main.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">
  
  
  
    <link rel="stylesheet" href="/js/lib/lightbox/baguetteBox.min.css">
  
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
    function loadCSS(href, data, attr) {
      var sheet = document.createElement('link');
      sheet.ref = 'stylesheet';
      sheet.href = href;
      sheet.dataset[data] = attr;
      document.head.appendChild(sheet);
    }
    function changeCSS(cssFile, data, attr) {
      var oldlink = document.querySelector(data);
      var newlink = document.createElement("link");
      newlink.setAttribute("rel", "stylesheet");
      newlink.setAttribute("href", cssFile);
      newlink.dataset.prism = attr;
      document.head.replaceChild(newlink, oldlink);
    }
  </script>
  
    
  
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
  </script>
  
    <script>
      var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
        document.getElementById('theme-color').dataset.mode = getCssMediaQuery();
      }
    };
    setDarkmode();
    </script>
  
  
  
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.js" as="script">
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
  
  
<meta name="generator" content="Hexo 6.2.0"></head>

  <body>
    <div class="wrapper">
       
      <nav class="navbar">
  <div class="navbar-logo">
    <a class="navbar-logo-main" href="/">
      
        <img 
          class="navbar-logo-img"
          width="32"
          height="32"
          src="/img/website_logo.png" 
          alt="blog logo">
      
      <span class="navbar-logo-dsc">è‡ªç•™åœ°</span>
      </a>
  </div>
  <div class="navbar-menu">
    
      <a 
        href="/" 
        class="navbar-menu-item">
        
          ä¸»é¡µ
        
      </a>
    
      <a 
        href="/archives" 
        class="navbar-menu-item">
        
          æ–‡ç« 
        
      </a>
    
      <a 
        href="/tags" 
        class="navbar-menu-item">
        
          æ ‡ç­¾
        
      </a>
    
      <a 
        href="/categories" 
        class="navbar-menu-item">
        
          åˆ†ç±»
        
      </a>
    
      <a 
        href="/about" 
        class="navbar-menu-item">
        
          å…³äº
        
      </a>
    
      <a 
        href="/links" 
        class="navbar-menu-item">
        
          å‹é“¾
        
      </a>
    
    <button 
      class="navbar-menu-item darknavbar navbar-menu-btn" 
      aria-label="Toggle dark mode"
      id="dark">
      <i class="iconfont icon-weather"></i>
    </button>
    <button 
      class="navbar-menu-item searchnavbar navbar-menu-btn" 
      aria-label="Toggle search"
      id="search">
      <!-- <i 
        class="iconfont icon-search" 
        style="font-size: 1.2rem; font-weight: 400;">
      </i> -->
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img"
        class="iconify iconify--ion" width="28" height="28" preserveAspectRatio="xMidYMid meet" viewBox="0 0 512 512">
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M256 80a176 176 0 1 0 176 176A176 176 0 0 0 256 80Z"></path>
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M232 160a72 72 0 1 0 72 72a72 72 0 0 0-72-72Z"></path>
        <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="28"
          d="M283.64 283.64L336 336"></path>
      </svg>
    </button>
  </div>
</nav> 
      
      <div 
        id="local-search" 
        style="display: none">
        <input
          class="navbar-menu-item"
          id="search-input"
          placeholder="è¯·è¾“å…¥æœç´¢å†…å®¹..." />
        <div id="search-content"></div>
      </div>
      
      <div class="section-wrap">
        <div class="container">
          <div class="columns">
            <aside class="left-column">
              
              <div class="card card-author">
                
  <img 
    src="/img/author.png" 
    class="author-img"
    width="88"
    height="88"
    alt="author avatar">

<p class="author-name">JKLASDWD</p>
<p class="author-description">ç”µå­å†œæ°‘å·¥ï¼Œçƒ­çˆ±ä»£ç </p>
<div class="author-message">
  <a 
    class="author-posts-count" 
    href="/archives">
    <span>12</span>
    <span>Posts</span>
  </a>
  <a 
    class="author-categories-count" 
    href="/categories">
    <span>0</span>
    <span>Categories</span>
  </a>
  <a 
    class="author-tags-count" 
    href="/tags">
    <span>0</span>
    <span>Tags</span>
  </a>
</div>

  <div class="author-card-society">
    
      <div class="author-card-society-icon">
        <a target="_blank" rel="noopener" href="https://space.bilibili.com/5136111">
          <i class="iconfont icon-bilibili society-icon"></i>
        </a>
      </div>
    
      <div class="author-card-society-icon">
        <a target="_blank" rel="noopener" href="https://steamcommunity.com/profiles/76561198203652348/">
          <i class="iconfont icon-steam society-icon"></i>
        </a>
      </div>
    
  </div>

              </div>
               <div class="sticky-tablet">
  
  
    <article class="display-when-two-columns spacer">
      <div class="card card-content toc-card">
        <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-text">å†™åœ¨å‰é¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E7%9A%84%E7%8A%B6%E6%80%81%E6%9C%BA%E6%A8%A1%E5%9E%8B"><span class="toc-text">æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95-C-%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%8A%B6%E6%80%81%E6%9C%BA%E6%A8%A1%E5%9E%8B-%E8%AF%AD%E4%B9%89"><span class="toc-text">ç®€å• C ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ (è¯­ä¹‰)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Python%E4%B8%AD%E6%A8%A1%E6%8B%9F%E5%A4%9A%E7%BA%BF%E7%A8%8B%E3%80%81%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%93%8D%E4%BD%9C"><span class="toc-text">åœ¨Pythonä¸­æ¨¡æ‹Ÿå¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83"><span class="toc-text">5. å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E5%87%BA%E6%9B%B4%E5%A4%9A%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">é—®å‡ºæ›´å¤šçš„é—®é¢˜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E6%9C%BA%E7%9A%84%E9%9A%90%E5%90%AB%E5%81%87%E8%AE%BE"><span class="toc-text">çŠ¶æ€æœºçš„éšå«å‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%B1%82%E5%92%8C"><span class="toc-text">ä¾‹å­ï¼šæ±‚å’Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83-1-%EF%BC%9A%E6%8C%87%E4%BB%A4-x2F-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%8E%9F%E5%AD%90%E6%80%A7%E5%81%87%E8%AE%BE"><span class="toc-text">æ”¾å¼ƒ (1)ï¼šæŒ‡ä»¤&#x2F;ä»£ç æ‰§è¡ŒåŸå­æ€§å‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83%E5%8E%9F%E5%AD%90%E6%80%A7%E5%81%87%E8%AE%BE%E7%9A%84%E5%90%8E%E6%9E%9C"><span class="toc-text">æ”¾å¼ƒåŸå­æ€§å‡è®¾çš„åæœ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%B1%82%E5%92%8C-%E5%86%8D%E6%AC%A1%E5%87%BA%E7%8E%B0"><span class="toc-text">ä¾‹å­ï¼šæ±‚å’Œ (å†æ¬¡å‡ºç°)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83-2-%EF%BC%9A%E7%A8%8B%E5%BA%8F%E7%9A%84%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C%E5%81%87%E8%AE%BE"><span class="toc-text">æ”¾å¼ƒ (2)ï¼šç¨‹åºçš„é¡ºåºæ‰§è¡Œå‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E8%AF%81%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-text">ä¿è¯æ‰§è¡Œé¡ºåº</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E6%B1%82%E5%92%8C"><span class="toc-text">å®ç°æ­£ç¡®çš„æ±‚å’Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98%EF%BC%9A%E5%AE%9A%E4%B9%89"><span class="toc-text">äº’æ–¥é—®é¢˜ï¼šå®šä¹‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98%E7%9A%84%E7%BB%8F%E5%85%B8%E7%AE%97%E6%B3%95"><span class="toc-text">äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%81%87%E8%AE%BE"><span class="toc-text">å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Atomic-Exchange-%E5%AE%9E%E7%8E%B0"><span class="toc-text">Atomic Exchange å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%EF%BC%9A%E5%81%9A%E9%A2%98%E5%AE%B6-v-s-%E7%A7%91%E5%AD%A6%E5%AE%B6"><span class="toc-text">å®ç°äº’æ–¥ï¼šåšé¢˜å®¶ v.s. ç§‘å­¦å®¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%EF%BC%9A%E8%87%AA%E6%97%8B%E9%94%81"><span class="toc-text">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%EF%BC%9A%E8%87%AA%E6%97%8B%E9%94%81-1"><span class="toc-text">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E5%BC%BA%E5%A4%A7%E7%9A%84%E5%8E%9F%E5%AD%90%E6%8C%87%E4%BB%A4"><span class="toc-text">æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%87%BA%E7%9A%84-Compare-%E7%94%A8%E5%A4%84"><span class="toc-text">å¤šå‡ºçš„ Compare: ç”¨å¤„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="toc-text">è‡ªæ—‹é”çš„ç¼ºé™·</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scalability-%E6%80%A7%E8%83%BD%E7%9A%84%E6%96%B0%E7%BB%B4%E5%BA%A6"><span class="toc-text">Scalability: æ€§èƒ½çš„æ–°ç»´åº¦</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B-%E9%95%BF%E4%B8%B4%E7%95%8C%E5%8C%BA%E7%9A%84%E4%BA%92%E6%96%A5"><span class="toc-text">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B-%E9%95%BF%E4%B8%B4%E7%95%8C%E5%8C%BA%E7%9A%84%E4%BA%92%E6%96%A5-cont%E2%80%99d"><span class="toc-text">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥ (contâ€™d)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E4%BA%92%E6%96%A5%E7%9A%84%E4%B8%80%E4%BA%9B%E5%88%86%E6%9E%90"><span class="toc-text">å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E8%B0%83%E8%AF%95%E4%B9%8B%E5%89%8D"><span class="toc-text">å¼€å§‹è°ƒè¯•ä¹‹å‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%9B%B0%E9%9A%BE%E7%9A%84%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0"><span class="toc-text">è°ƒè¯•å›°éš¾çš„æ ¹æœ¬åŸå› </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA"><span class="toc-text">è°ƒè¯•ç†è®º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA-cont%E2%80%99d"><span class="toc-text">è°ƒè¯•ç†è®º (contâ€™d)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%A0%E4%BB%AC%E6%98%AF%E5%90%A6%E9%81%87%E5%88%B0%E8%BF%87%E4%BB%A5%E4%B8%8B%E4%BB%A4%E4%BA%BA%E6%8A%93%E7%8B%82%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%9F"><span class="toc-text">ä½ ä»¬æ˜¯å¦é‡åˆ°è¿‡ä»¥ä¸‹ä»¤äººæŠ“ç‹‚çš„æƒ…å†µï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%96%E7%95%8C%EF%BC%9A%E4%B8%80%E5%88%87%E7%9A%86%E5%8F%AF%E8%B0%83%E8%AF%95"><span class="toc-text">è®¡ç®—æœºä¸–ç•Œï¼šä¸€åˆ‡çš†å¯è°ƒè¯•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA"><span class="toc-text">ä½¿ç”¨è°ƒè¯•ç†è®º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GDB-%E5%85%A5%E9%97%A8"><span class="toc-text">GDB: å…¥é—¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA%EF%BC%9A%E5%BA%94%E7%94%A8-Again"><span class="toc-text">è°ƒè¯•ç†è®ºï¼šåº”ç”¨ (Again)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A8%8B%E5%9F%BA%E6%9C%AC%E5%87%86%E5%88%99%EF%BC%9A%E5%9B%9E%E9%A1%BE"><span class="toc-text">ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA%E7%9A%84%E6%9C%80%E9%87%8D%E8%A6%81%E5%BA%94%E7%94%A8"><span class="toc-text">è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E7%BB%B4%E6%8A%A4%E7%88%B6%E4%BA%B2%E8%8A%82%E7%82%B9%E7%9A%84%E5%B9%B3%E8%A1%A1%E6%A0%91"><span class="toc-text">ä¾‹å­ï¼šç»´æŠ¤çˆ¶äº²èŠ‚ç‚¹çš„å¹³è¡¡æ ‘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A6%8F%E5%88%A9%EF%BC%9A%E6%9B%B4%E5%A4%9A%E7%9A%84%E6%96%AD%E8%A8%80"><span class="toc-text">ç¦åˆ©ï¼šæ›´å¤šçš„æ–­è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%EF%BC%9A%E4%B8%87%E8%83%BD%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6-M2"><span class="toc-text">æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶ (M2)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%EF%BC%9A%E6%9B%B4%E5%8F%A4%E6%80%AA%E7%9A%84%E4%B9%A0%E9%A2%98-x2F-%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-text">æ¡ä»¶å˜é‡ï¼šæ›´å¤æ€ªçš„ä¹ é¢˜&#x2F;é¢è¯•é¢˜</span></a>
      </div>
    </article>
  
  
  <article class="card card-content categories-widget">
    <div class="categories-card">
  <div class="categories-header">
    <i 
      class="iconfont icon-fenlei" 
      style="padding-right: 2px;">
    </i>Categories
  </div>
  <div class="categories-list">
    
  </div>
</div>
  </article>
  
  <article class="card card-content tags-widget">
    <div class="tags-card">
  <div class="tags-header">
    <i 
      class="iconfont icon-biaoqian" 
      style="padding-right: 2px;">
    </i>hot tags
  </div>
  <div class="tags-list">
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
            <main class="main-column">
              
<article class="card card-content">
  <header>
    <h1 class="post-title">
      æ“ä½œç³»ç»Ÿ
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2023-07-29T13:38:52.000Z">
      <i 
        class="iconfont icon-calendar" 
        style="margin-right: 2px;">
      </i>
      <span>2023-07-29</span>
    </time>
    
    
      <span class="dot"></span>
      <span>11.1k words</span>
    
  </div>
  
  </header>
  <div 
    id="section" 
    class="post-content">
    <h3 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h3><p>æˆªæ­¢åˆ°2023.7.29çš„å—äº¬å¤§å­¦jyyçš„2023æ“ä½œç³»ç»Ÿè¯¾çš„ç¬”è®°ï¼Œå¼ºçƒˆæ¨è</p>
<p>è®©æˆ‘æ„Ÿè§‰å­¦çš„æ•°å­—ç”µè·¯â€œç¨å¾®â€æœ‰é‚£ä¹ˆä¸€ç‚¹ç”¨çš„è¯¾</p>
<p>å¾ˆå¯æƒœï¼Œå—å¤§çš„æ ¡å†…OJå¹¶ä¸å¯¹å¤–æ ¡å¼€æ”¾ï¼Œå®éªŒä»£ç çš„æ­£ç¡®æ€§æ— ä»è€ƒè¯ï¼ˆ</p>
<p>ä½†è¿˜æ˜¯å¼ºçƒˆæ¨èï¼Œjyyè®²çš„çš„ç¡®å¥½</p>
<p>è¯¾ç¨‹ä¸»é¡µï¼š<a target="_blank" rel="noopener" href="https://jyywiki.cn/OS/2023">https://jyywiki.cn/OS/2023</a></p>
<p>è¯¾ç¨‹æ•™ç§‘ä¹¦ï¼šOperating Systems: Three Easy Pieces</p>
<p><a target="_blank" rel="noopener" href="https://pages.cs.wisc.edu/~remzi/OSTEP/">https://pages.cs.wisc.edu/~remzi/OSTEP/</a></p>
<p>ï¼ˆå®åœ¨çœ‹ä¸ä¸‹å»è‹±æ–‡å¯ä»¥å»æ‰¾ä¸­æ–‡ç‰ˆï¼Œè™½ç„¶ç¿»è¯‘ä¸å’‹åœ°ï¼Œä½†è¿˜ç®—èƒ½çœ‹ï¼‰</p>
<p>ä»¥ä¸‹æ˜¯æ­£æ–‡ï¼ŒåŒ…å«è¯­åºæ··ä¹±ä»¥åŠå„ç§ä¹±ä¸ƒå…«ç³Ÿçš„æ³¨è§£ï¼ˆ</p>
<p>å›¾åºŠæ˜¯è‡ªç”¨çš„è…¾è®¯äº‘COSï¼Œè¿˜ç®—å¯ä»¥ï¼Ÿ</p>
<p>æ“ä½œç³»ç»Ÿ</p>
<p>æ±‡ç¼–ä»£ç å’Œæœ€å°å¯æ‰§è¡Œæ–‡ä»¶</p>
<p>æœ€å°å¯æ‰§è¡Œï¼Ÿä¼šæƒ³åˆ°Hello World</p>
<pre class="highlight"><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre>

<p>å‘½ä»¤è¡Œ</p>
<pre class="highlight"><span class="line">gcc hello.c</span><br><span class="line">file a.out</span><br><span class="line">./a.out </span><br><span class="line">--&gt;Hello World</span><br><span class="line">objdumpå‘½ä»¤è¿›è¡Œåæ±‡ç¼–</span><br><span class="line">gcc hello.c -static</span><br><span class="line">gcc hello.c -static | less</span><br><span class="line">gcc hello.c -static | wc -l</span><br><span class="line">gcc hello.c -static --verbose</span><br></pre>

<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230720184929.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230720184929.png"></p>
<p>ç¼–è¯‘è¿‡ç¨‹</p>
<p>.c â€”&gt; .i         </p>
<p>.iâ€”-&gt; .s        </p>
<p>.sâ€”-&gt;.o</p>
<p>.oâ€”-&gt;.out </p>
<pre class="highlight"><span class="line">gcc hello.c -static -Wl --verbose</span><br></pre>



<p>è§£å†³å¼‚å¸¸é€€å‡º</p>
<p>â€“&gt;â€syscallâ€</p>
<pre class="highlight"><span class="line">movq $SYS_exit, %rax</span><br><span class="line">movq $1, %rdl</span><br><span class="line">syscall</span><br><span class="line">æŠŠæ§åˆ¶æƒå®Œå…¨äº¤ç»™æ“ä½œç³»ç»Ÿ</span><br><span class="line">æ“ä½œç³»ç»Ÿå¯ä»¥æ”¹å˜ç¨‹åºçŠ¶æ€ç”šè‡³ç»ˆæ­¢ç¨‹åº</span><br></pre>

<p>ï¼ˆmovqç­‰æŒ‡ä»¤ä¸ºæ±‡ç¼–æŒ‡ä»¤é›†ï¼‰</p>
<h3 id="æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹"><a href="#æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹" class="headerlink" title="æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹"></a>æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹</h3><p>â€‹	Everything is a state machine: è®¡ç®—æœº &#x3D; æ•°å­—ç”µè·¯ &#x3D; çŠ¶æ€æœº</p>
<p>â€‹	çŠ¶æ€ &#x3D; å†…å­˜ MM + å¯„å­˜å™¨ RR<br>â€‹	åˆå§‹çŠ¶æ€ &#x3D; ABI è§„å®š (ä¾‹å¦‚æœ‰ä¸€ä¸ªåˆæ³•çš„ %rsp)<br>â€‹	çŠ¶æ€è¿ç§» &#x3D; æ‰§è¡Œä¸€æ¡æŒ‡ä»¤<br>â€‹		æˆ‘ä»¬èŠ±äº†ä¸€æ•´ä¸ªã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹è§£é‡Šè¿™ä»¶äº‹<br>â€‹		gdb åŒæ ·å¯ä»¥è§‚å¯ŸçŠ¶æ€å’Œæ‰§è¡Œ<br>æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº</p>
<p>æ‰€æœ‰çš„æŒ‡ä»¤éƒ½åªèƒ½è®¡ç®—<br>    deterministic: mov, add, sub, call, â€¦<br>    non-deterministic: rdrand, â€¦<br>    syscall æŠŠ (M,R)(M,R) å®Œå…¨äº¤ç»™æ“ä½œç³»ç»Ÿ</p>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230720220918.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230720220918.png"></p>
<p>ç¼–è¯‘å™¨ â€”&gt; å–æ ˆé¡¶çš„pcå€¼ï¼Œæ‰§è¡Œå¯¹åº”è¯­å¥</p>
<p>æŠŠé«˜çº§è¯­è¨€ç¼–è¯‘æˆä¸ºä¸€ä¸ªçŠ¶æ€æœºï¼Œæ‰§è¡ŒæŒ‡ä»¤åºåˆ—</p>
<h3 id="ç®€å•-C-ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹-è¯­ä¹‰"><a href="#ç®€å•-C-ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹-è¯­ä¹‰" class="headerlink" title="ç®€å• C ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ (è¯­ä¹‰)"></a>ç®€å• C ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ (è¯­ä¹‰)</h3><p>å¯¹ C ç¨‹åºåšå‡ºç®€åŒ–</p>
<p>ç®€åŒ–ï¼šæ”¹å†™æˆæ¯æ¡è¯­å¥è‡³å¤šä¸€æ¬¡è¿ç®—&#x2F;å‡½æ•°è°ƒç”¨çš„å½¢å¼<br>çœŸçš„æœ‰è¿™ç§å·¥å…· (C Intermediate Language) å’Œè§£é‡Šå™¨<br>çŠ¶æ€æœºå®šä¹‰</p>
<p>çŠ¶æ€ &#x3D; å † + æ ˆ<br>åˆå§‹çŠ¶æ€ &#x3D; main çš„ç¬¬ä¸€æ¡è¯­å¥<br>çŠ¶æ€è¿ç§» &#x3D; æ‰§è¡Œä¸€æ¡è¯­å¥ä¸­çš„ä¸€å°æ­¥<br>(è¿™è¿˜åªæ˜¯ â€œç²—æµ…â€ çš„ç†è§£)</p>
<p>Talk is cheap. Show me the code. (Linus Torvalds)<br>ä»»ä½•çœŸæ­£çš„ç†è§£éƒ½åº”è¯¥è½åˆ°å¯ä»¥æ‰§è¡Œçš„ä»£ç </p>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230721002850.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230721002850.png"></p>
<p>:%!xxd</p>
<p>%â€“&gt;å…¨é€‰  (1,$)</p>
<p>!â€”&gt;è°ƒç”¨ç¬¬ä¸‰æ–¹å‘½ä»¤</p>
<p>xxdâ€“&gt;åå…­è¿›åˆ¶æ ¼å¼æŸ¥çœ‹æ–‡ä»¶</p>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230721003042.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230721003042.png"></p>
<p>ELFâ€”&gt;å¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶å¤´</p>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230721012511.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230721012511.png"></p>
<p>strace -f gcc hello.c |&amp; vim -</p>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230722010844.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230722010844.png"></p>
<p>CPUâ€”&gt;FirmWareï¼ˆä¸»æ¿ï¼‰</p>
<p>CPU ç»è¿‡Resetåï¼Œå¯„å­˜å™¨æ¸…ç©ºï¼Œå†rebootï¼Œå°†firmwareä¸Šçš„æŒ‡ä»¤åŠ è½½åˆ°å†…å­˜ä¸Šï¼Œä¸€å¥å¥æ‰§è¡Œï¼Œå¯åŠ¨æ“ä½œç³»ç»Ÿ</p>
<p>BIOS æä¾›æœºåˆ¶ï¼Œå°†ç¨‹åºå‘˜çš„ä»£ç è½½å…¥å†…å­˜</p>
<p>Legacy BIOS æŠŠç¬¬ä¸€ä¸ªå¯å¼•å¯¼è®¾å¤‡çš„ç¬¬ä¸€ä¸ª 512 å­—èŠ‚åŠ è½½åˆ°ç‰©ç†å†…å­˜çš„ 7c00 ä½ç½®<br>æ­¤æ—¶å¤„ç†å™¨å¤„äº 16-bit æ¨¡å¼<br>è§„å®š CS:IP &#x3D; 0x7c00, (R[CS] &lt;&lt; 4) | R[IP] &#x3D;&#x3D; 0x7c00<br>å¯èƒ½æ€§1ï¼šCS &#x3D; 0x07c0, IP &#x3D; 0<br>å¯èƒ½æ€§2ï¼šCS &#x3D; 0, IP &#x3D; 0x7c00<br>å…¶ä»–æ²¡æœ‰ä»»ä½•çº¦æŸ</p>
<p>55aa å¼•å¯¼åˆ†åŒºæ ‡è®°ï¼ˆå¯åŠ¨ç›˜ï¼‰</p>
<p>æˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„æ¦‚å¿µ</p>
<p>1.åº”ç”¨ç¨‹åº (é«˜çº§è¯­è¨€çŠ¶æ€æœº)<br>2.ç³»ç»Ÿè°ƒç”¨ (æ“ä½œç³»ç»Ÿ API)<br>3.æ“ä½œç³»ç»Ÿå†…éƒ¨å®ç°<br>æ²¡æœ‰äººè§„å®šä¸Šé¢ä¸‰è€…å¦‚ä½•å®ç°</p>
<p>é€šå¸¸çš„æ€è·¯ï¼šçœŸå®çš„æ“ä½œç³»ç»Ÿ + QEMU&#x2F;NEMU æ¨¡æ‹Ÿå™¨<br>æˆ‘ä»¬çš„æ€è·¯<br>åº”ç”¨ç¨‹åº &#x3D; çº¯ç²¹è®¡ç®—çš„ Python ä»£ç  + ç³»ç»Ÿè°ƒç”¨<br>æ“ä½œç³»ç»Ÿ &#x3D; Python ç³»ç»Ÿè°ƒç”¨å®ç°ï¼Œæœ‰ â€œå‡æƒ³â€ çš„ I&#x2F;O è®¾å¤‡<br>def main():<br>    sys_write(â€˜Hello, OS Worldâ€™)</p>
<h3 id="åœ¨Pythonä¸­æ¨¡æ‹Ÿå¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹æ“ä½œ"><a href="#åœ¨Pythonä¸­æ¨¡æ‹Ÿå¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹æ“ä½œ" class="headerlink" title="åœ¨Pythonä¸­æ¨¡æ‹Ÿå¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹æ“ä½œ"></a>åœ¨Pythonä¸­æ¨¡æ‹Ÿå¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹æ“ä½œ</h3><p>yieldå…³é”®å­—ï¼šreturnä¸€ä¸ªå€¼ï¼Œä½†æ˜¯å¯¹åº”çš„å¯¹è±¡å¹¶æœªé€€å‡º</p>
<p>åˆ©ç”¨yieldå®ç°ä¸€ä¸ªæ¨¡æ‹Ÿçš„æ“ä½œç³»ç»Ÿ</p>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230722220843.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230722220843.png"></p>
<p>å¤šçº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ï¼Ÿ</p>
<p>os-model</p>
<pre class="highlight"><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OperatingSystem</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A minimal executable operating system model.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    SYSCALLS = [<span class="string">&#x27;choose&#x27;</span>, <span class="string">&#x27;write&#x27;</span>, <span class="string">&#x27;spawn&#x27;</span>, <span class="string">&#x27;sched&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Thread</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;A &quot;freezed&quot; thread state.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, func, *args</span>):</span><br><span class="line">            self._func = func(*args)</span><br><span class="line">            self.retval = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">step</span>(<span class="params">self</span>):</span><br><span class="line">            <span class="string">&quot;&quot;&quot;Proceed with the thread until its next trap.&quot;&quot;&quot;</span></span><br><span class="line">            syscall, args, *_ = self._func.send(self.retval)</span><br><span class="line">            self.retval = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">return</span> syscall, args</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, src</span>):</span><br><span class="line">        variables = &#123;&#125;</span><br><span class="line">        <span class="built_in">exec</span>(src, variables)</span><br><span class="line">        self._main = variables[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        threads = [OperatingSystem.Thread(self._main)]</span><br><span class="line">        <span class="keyword">while</span> threads:  <span class="comment"># Any thread lives</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">match</span> (t := threads[<span class="number">0</span>]).step():</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;choose&#x27;</span>, xs:  <span class="comment"># Return a random choice</span></span><br><span class="line">                        t.retval = random.choice(xs)</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;write&#x27;</span>, xs:  <span class="comment"># Write to debug console</span></span><br><span class="line">                        <span class="built_in">print</span>(xs, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;spawn&#x27;</span>, (fn, args):  <span class="comment"># Spawn a new thread</span></span><br><span class="line">                        threads += [OperatingSystem.Thread(fn, *args)]</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;sched&#x27;</span>, _:  <span class="comment"># Non-deterministic schedule</span></span><br><span class="line">                        random.shuffle(threads)</span><br><span class="line">            <span class="keyword">except</span> StopIteration:  <span class="comment"># A thread terminates</span></span><br><span class="line">                threads.remove(t)</span><br><span class="line">                random.shuffle(threads)  <span class="comment"># sys_sched()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Usage: <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span> file&#x27;</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    src = Path(sys.argv[<span class="number">1</span>]).read_text()</span><br><span class="line">    <span class="keyword">for</span> syscall <span class="keyword">in</span> OperatingSystem.SYSCALLS:</span><br><span class="line">        src = src.replace(<span class="string">f&#x27;sys_<span class="subst">&#123;syscall&#125;</span>&#x27;</span>,        <span class="comment"># sys_write(...)</span></span><br><span class="line">                          <span class="string">f&#x27;yield &quot;<span class="subst">&#123;syscall&#125;</span>&quot;, &#x27;</span>)  <span class="comment">#  -&gt; yield &#x27;write&#x27;, (...)</span></span><br><span class="line"></span><br></pre>



<pre class="highlight"><span class="line">mosaic åœ°å€ https://jyywiki.cn/pages/OS/2023/mosaic/mosaic.py</span><br></pre>

<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230722230152.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230722230152.png"></p>
<p>æœ€å°å€¼ï¼Œä¸ºä»€ä¹ˆæ˜¯<strong>2</strong>ï¼Ÿ</p>
<pre class="highlight"><span class="line">åº”è¯¥æ˜¯æœ‰é”™çš„ï¼Œæ­£ç¡®çš„åº”è¯¥éœ€è¦åœ¨heap.xï¼tmpè¯­å¥ååŠ ä¸€ä¸ªschedã€‚</span><br><span class="line">å¦‚æœæ²¡æœ‰è¿™ä¸ªschedï¼Œå¯¹äºå½“å‰æ‰§è¡ŒTsumçš„generatorè€Œè¨€ï¼Œåœ¨å½“å‰å¾ªç¯æ‰§è¡Œç¬¬ä¸€å¥tmpï¼heap.xæ—¶ï¼Œheap.xçš„å€¼ä¸€å®šæ˜¯è‡ªå·±åœ¨ä¸Šä¸ªå¾ªç¯åˆšèµ‹å€¼è¿‡çš„å€¼ï¼ˆå› ä¸ºè¿™ä¸¤ä¸ªå¾ªç¯çš„è¡”æ¥å¤„æ²¡æœ‰schedå°±åªèƒ½è¿™æ ·æ‰§è¡Œï¼‰ï¼Œè€Œæ„é€ æœ€å°å€¼çš„å…³é”®ï¼Œå°±æ˜¯è¦æœ‰æœºä¼šæ¯æ¬¡è¯»å–heap.xçš„å€¼çš„æ—¶å€™èƒ½å¤Ÿæœ‰æœºä¼šè¯»å–åˆ«çš„generatoråˆšèµ‹å€¼è¿‡çš„å€¼ï¼Œåªæœ‰è¿™æ ·æ‰å¯ä»¥åœ¨å½“å‰generatorçš„æœ€åä¸€ä¸ªå¾ªç¯æ‹¿åˆ°åˆ«çš„generatoråˆšèµ°å®Œç¬¬ä¸€ä¸ªå¾ªç¯æ—¶çš„å€¼ï¼Œä»è€Œæ„å»ºæœ€å°å€¼ã€‚</span><br></pre>

<h3 id="5-å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ"><a href="#5-å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ" class="headerlink" title="5. å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ"></a>5. å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ</h3><p>çº¿ç¨‹ï¼šå…±äº«å†…å­˜çš„æ‰§è¡Œæµ</p>
<ul>
<li>æ‰§è¡Œæµæ‹¥æœ‰ç‹¬ç«‹çš„å †æ ˆ&#x2F;å¯„å­˜å™¨</li>
</ul>
<hr>
<p>ç®€åŒ–çš„çº¿ç¨‹ API (thread.h)</p>
<ul>
<li>&#96;&#96;&#96;<br>spawn(fn)<pre class="highlight"><span class="line"></span><br><span class="line">- åˆ›å»ºä¸€ä¸ªå…¥å£å‡½æ•°æ˜¯</span><br><span class="line"></span><br></pre>
  fn  <pre class="highlight"><span class="line"></span><br><span class="line">    çš„çº¿ç¨‹ï¼Œå¹¶ç«‹å³å¼€å§‹æ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">    - `void fn(int tid) &#123; ... &#125;`</span><br><span class="line">    - å‚æ•° `tid` ä» 1 å¼€å§‹ç¼–å·</span><br><span class="line"></span><br><span class="line">  - è¡Œä¸ºï¼š`sys_spawn(fn, tid)`</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  join()</span><br></pre>

<ul>
<li>ç­‰å¾…æ‰€æœ‰è¿è¡Œçº¿ç¨‹çš„è¿”å› (ä¹Ÿå¯ä»¥ä¸è°ƒç”¨)</li>
<li>è¡Œä¸ºï¼š<code>while (done != T) sys_sched()</code></li>
</ul>
</li>
</ul>
<p>å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä¸€ä¸ª API æå®š</p>
<pre class="highlight"><span class="line">#include &quot;thread.h&quot;</span><br><span class="line"></span><br><span class="line">void Ta() &#123; while (1) &#123; printf(&quot;a&quot;); &#125; &#125;</span><br><span class="line">void Tb() &#123; while (1) &#123; printf(&quot;b&quot;); &#125; &#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  create(Ta);</span><br><span class="line">  create(Tb);</span><br><span class="line">&#125;</span><br></pre>

<ul>
<li>è¿™ä¸ªç¨‹åºå¯ä»¥åˆ©ç”¨ç³»ç»Ÿä¸­çš„å¤šå¤„ç†å™¨<ul>
<li>æ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨æŠŠçº¿ç¨‹æ”¾ç½®åœ¨ä¸åŒçš„å¤„ç†å™¨ä¸Š</li>
<li>CPU ä½¿ç”¨ç‡è¶…è¿‡äº† 100%</li>
</ul>
</li>
</ul>
<h4 id="é—®å‡ºæ›´å¤šçš„é—®é¢˜"><a href="#é—®å‡ºæ›´å¤šçš„é—®é¢˜" class="headerlink" title="é—®å‡ºæ›´å¤šçš„é—®é¢˜"></a>é—®å‡ºæ›´å¤šçš„é—®é¢˜</h4><p><code>Ta</code> å’Œ <code>Tb</code> çœŸçš„å…±äº«å†…å­˜å—ï¼Ÿ</p>
<ul>
<li>å¦‚ä½•è¯æ˜&#x2F;å¦è¯è¿™ä»¶äº‹ï¼Ÿ</li>
</ul>
<hr>
<p>å¦‚ä½•è¯æ˜çº¿ç¨‹å…·æœ‰ç‹¬ç«‹å †æ ˆ (ä»¥åŠç¡®å®šå †æ ˆçš„èŒƒå›´)ï¼Ÿ</p>
<ul>
<li>è¾“å‡ºæ··ä¹±ï¼Œåº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ</li>
</ul>
<h2 id="çŠ¶æ€æœºçš„éšå«å‡è®¾"><a href="#çŠ¶æ€æœºçš„éšå«å‡è®¾" class="headerlink" title="çŠ¶æ€æœºçš„éšå«å‡è®¾"></a>çŠ¶æ€æœºçš„éšå«å‡è®¾</h2><p>â€œä¸–ç•Œä¸Šåªæœ‰ä¸€ä¸ªçŠ¶æ€æœºâ€</p>
<ul>
<li>æ²¡æœ‰å…¶ä»–ä»»ä½•äººèƒ½ â€œå¹²æ¶‰â€ ç¨‹åºçš„çŠ¶æ€</li>
<li>æ¨è®ºï¼šå¯¹å˜é‡çš„ load ä¸€å®šè¿”å›æœ¬çº¿ç¨‹æœ€åä¸€æ¬¡ store çš„å€¼<ul>
<li>è¿™ä¹Ÿæ˜¯ç¼–è¯‘ä¼˜åŒ–çš„åŸºæœ¬å‡è®¾</li>
</ul>
</li>
</ul>
<hr>
<p>ä½†å…±äº«å†…å­˜æ¨ç¿»äº†è¿™ä¸ªå‡è®¾</p>
<pre class="highlight"><span class="line">int Tworker() &#123;</span><br><span class="line">  printf(&quot;%d\n&quot;, x);  // Global x</span><br><span class="line">  printf(&quot;%d\n&quot;, x);</span><br><span class="line">&#125;</span><br></pre>

<ul>
<li>å…¶ä»–çº¿ç¨‹éšæ—¶å¯ä»¥ä¿®æ”¹x<ul>
<li>å¯¼è‡´ä¸¤æ¬¡å¯èƒ½è¯»åˆ°ä¸åŒçš„ <code>x</code></li>
</ul>
</li>
</ul>
<h2 id="ä¾‹å­ï¼šæ±‚å’Œ"><a href="#ä¾‹å­ï¼šæ±‚å’Œ" class="headerlink" title="ä¾‹å­ï¼šæ±‚å’Œ"></a>ä¾‹å­ï¼šæ±‚å’Œ</h2><p>åˆ†ä¸¤ä¸ªçº¿ç¨‹ï¼Œè®¡ç®— 1+1+1+â€¦+1+1+1(å…±è®¡ 2n ä¸ª 1)</p>
<pre class="highlight"><span class="line">#define N 100000000</span><br><span class="line">long sum = 0;</span><br><span class="line"></span><br><span class="line">void Tsum() &#123; for (int i = 0; i &lt; N; i++) sum++; &#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  create(Tsum);</span><br><span class="line">  create(Tsum);</span><br><span class="line">  join();</span><br><span class="line">  printf(&quot;sum = %ld\n&quot;, sum);</span><br><span class="line">&#125;</span><br></pre>

<p>å¯èƒ½çš„ç»“æœ</p>
<ul>
<li>119790390, 99872322 (ç»“æœå¯ä»¥æ¯” <code>N</code> è¿˜è¦å°), â€¦</li>
<li>ç›´æ¥ä½¿ç”¨æ±‡ç¼–æŒ‡ä»¤ä¹Ÿä¸è¡Œ</li>
</ul>
<h2 id="æ”¾å¼ƒ-1-ï¼šæŒ‡ä»¤-x2F-ä»£ç æ‰§è¡ŒåŸå­æ€§å‡è®¾"><a href="#æ”¾å¼ƒ-1-ï¼šæŒ‡ä»¤-x2F-ä»£ç æ‰§è¡ŒåŸå­æ€§å‡è®¾" class="headerlink" title="æ”¾å¼ƒ (1)ï¼šæŒ‡ä»¤&#x2F;ä»£ç æ‰§è¡ŒåŸå­æ€§å‡è®¾"></a>æ”¾å¼ƒ (1)ï¼šæŒ‡ä»¤&#x2F;ä»£ç æ‰§è¡ŒåŸå­æ€§å‡è®¾</h2><blockquote>
<p>â€œå¤„ç†å™¨ä¸€æ¬¡æ‰§è¡Œä¸€æ¡æŒ‡ä»¤â€ çš„åŸºæœ¬å‡è®¾åœ¨ä»Šå¤©çš„è®¡ç®—æœºç³»ç»Ÿä¸Šä¸å†æˆç«‹ (æˆ‘ä»¬çš„æ¨¡å‹ä½œå‡ºäº†ç®€åŒ–çš„å‡è®¾)ã€‚</p>
</blockquote>
<p>å•å¤„ç†å™¨å¤šçº¿ç¨‹</p>
<ul>
<li>çº¿ç¨‹åœ¨è¿è¡Œæ—¶å¯èƒ½è¢«ä¸­æ–­ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ</li>
</ul>
<p>å¤šå¤„ç†å™¨å¤šçº¿ç¨‹</p>
<ul>
<li>çº¿ç¨‹æ ¹æœ¬å°±æ˜¯å¹¶è¡Œæ‰§è¡Œçš„</li>
</ul>
<hr>
<p>(å†å²) 1960sï¼Œå¤§å®¶äº‰å…ˆåœ¨å…±äº«å†…å­˜ä¸Šå®ç°åŸå­æ€§ (äº’æ–¥)</p>
<ul>
<li>ä½†å‡ ä¹æ‰€æœ‰çš„å®ç°éƒ½æ˜¯é”™çš„ï¼Œç›´åˆ° <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Dekker's_algorithm">Dekkerâ€™s Algorithm</a>ï¼Œè¿˜åªèƒ½ä¿è¯ä¸¤ä¸ªçº¿ç¨‹çš„äº’æ–¥</li>
</ul>
<h2 id="æ”¾å¼ƒåŸå­æ€§å‡è®¾çš„åæœ"><a href="#æ”¾å¼ƒåŸå­æ€§å‡è®¾çš„åæœ" class="headerlink" title="æ”¾å¼ƒåŸå­æ€§å‡è®¾çš„åæœ"></a>æ”¾å¼ƒåŸå­æ€§å‡è®¾çš„åæœ</h2><p><code>printf</code> è¿˜èƒ½åœ¨å¤šçº¿ç¨‹ç¨‹åºé‡Œè°ƒç”¨å—ï¼Ÿ</p>
<pre class="highlight"><span class="line">void thread1() &#123; while (1) &#123; printf(&quot;a&quot;); &#125; &#125;</span><br><span class="line">void thread2() &#123; while (1) &#123; printf(&quot;b&quot;); &#125; &#125;</span><br></pre>

<p>æˆ‘ä»¬éƒ½çŸ¥é“ printf æ˜¯æœ‰ç¼“å†²åŒºçš„ (ä¸ºä»€ä¹ˆï¼Ÿ)</p>
<ul>
<li>å¦‚æœæ‰§è¡Œ <code>buf[pos++] = ch</code> (<code>pos</code> å…±äº«) ä¸å°± ğŸ’¥ äº†å—ï¼Ÿ</li>
<li>printf()åœ¨å…¶å®˜æ–¹æ–‡æ¡£ä¸­æåˆ°äº†è¿™ä¸€ç‚¹ï¼Œå®ƒæ˜¯å¤šçº¿ç¨‹å®‰å…¨çš„(MT-safe)</li>
</ul>
<h2 id="ä¾‹å­ï¼šæ±‚å’Œ-å†æ¬¡å‡ºç°"><a href="#ä¾‹å­ï¼šæ±‚å’Œ-å†æ¬¡å‡ºç°" class="headerlink" title="ä¾‹å­ï¼šæ±‚å’Œ (å†æ¬¡å‡ºç°)"></a>ä¾‹å­ï¼šæ±‚å’Œ (å†æ¬¡å‡ºç°)</h2><p>åˆ†ä¸¤ä¸ªçº¿ç¨‹ï¼Œè®¡ç®— 1+1+1+\ldots+11+1+1+â€¦+1 (å…±è®¡ 2n2<em>n</em> ä¸ª 11)</p>
<pre class="highlight"><span class="line">#define N 100000000</span><br><span class="line">long sum = 0;</span><br><span class="line"></span><br><span class="line">void Tsum() &#123; for (int i = 0; i &lt; N; i++) sum++; &#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  create(Tsum);</span><br><span class="line">  create(Tsum);</span><br><span class="line">  join();</span><br><span class="line">  printf(&quot;sum = %ld\n&quot;, sum);</span><br><span class="line">&#125;</span><br></pre>

<p>å¦‚æœæ·»åŠ ç¼–è¯‘ä¼˜åŒ–ï¼Ÿ</p>
<ul>
<li><code>-O1</code>: 100000000 </li>
<li><code>-O2</code>: 200000000</li>
</ul>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230724124153.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230724124153.png"></p>
<p>-O1ï¼Œä¸¤ä¸ªçº¿ç¨‹ç°å°†sumçš„å€¼è¯»å…¥åˆ°å¯„å­˜å™¨%rdxä¸­ï¼Œå†å°†å¾ªç¯åçš„å€¼èµ‹åˆ°sumä¹‹ä¸­</p>
<p>-O2ï¼Œç›´æ¥å°†å¾ªç¯æ‹†å¼€æˆä¸ºå¸¸æ•°</p>
<h2 id="æ”¾å¼ƒ-2-ï¼šç¨‹åºçš„é¡ºåºæ‰§è¡Œå‡è®¾"><a href="#æ”¾å¼ƒ-2-ï¼šç¨‹åºçš„é¡ºåºæ‰§è¡Œå‡è®¾" class="headerlink" title="æ”¾å¼ƒ (2)ï¼šç¨‹åºçš„é¡ºåºæ‰§è¡Œå‡è®¾"></a>æ”¾å¼ƒ (2)ï¼šç¨‹åºçš„é¡ºåºæ‰§è¡Œå‡è®¾</h2><blockquote>
<p>ç¼–è¯‘å™¨å¯¹å†…å­˜è®¿é—® â€œeventually consistentâ€ çš„å¤„ç†å¯¼è‡´å…±äº«å†…å­˜ä½œä¸ºçº¿ç¨‹åŒæ­¥å·¥å…·çš„å¤±æ•ˆã€‚</p>
</blockquote>
<p>åˆšæ‰çš„ä¾‹å­</p>
<ul>
<li><code>-O1</code>: <code>R[eax] = sum; R[eax] += N; sum = R[eax]</code></li>
<li><code>-O2</code>: <code>sum += N;</code></li>
<li>(ä½ çš„ç¼–è¯‘å™¨ä¹Ÿè®¸æ˜¯ä¸åŒçš„ç»“æœ)</li>
</ul>
<p>å¦ä¸€ä¸ªä¾‹å­</p>
<pre class="highlight"><span class="line">while (!done);</span><br><span class="line">// would be optimized to</span><br><span class="line">if (!done) while (1);</span><br></pre>

<h2 id="ä¿è¯æ‰§è¡Œé¡ºåº"><a href="#ä¿è¯æ‰§è¡Œé¡ºåº" class="headerlink" title="ä¿è¯æ‰§è¡Œé¡ºåº"></a>ä¿è¯æ‰§è¡Œé¡ºåº</h2><p>å›å¿† â€œç¼–è¯‘æ­£ç¡®æ€§â€</p>
<ul>
<li><p>C çŠ¶æ€å’Œæ±‡ç¼–çŠ¶æ€æœºçš„ â€œå¯è§‚æµ‹è¡Œä¸ºç­‰ä»·â€</p>
</li>
<li><p>æ–¹æ³• 1ï¼šæ’å…¥ â€œä¸å¯ä¼˜åŒ–â€ ä»£ç </p>
<ul>
<li>&#96;&#96;&#96;<br>asm volatile (â€œâ€ ::: â€œmemoryâ€);<pre class="highlight"><span class="line"></span><br><span class="line">    - â€œClobbers memoryâ€</span><br><span class="line"></span><br><span class="line">- æ–¹æ³• 2ï¼šæ ‡è®°å˜é‡ load/store ä¸ºä¸å¯ä¼˜åŒ–</span><br><span class="line"></span><br><span class="line">  - ä½¿ç”¨ `volatile` å˜é‡</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br></pre></li>
</ul>
</li>
</ul>
<p>extern int volatile done;</p>
<p>while (!done) ;</p>
<pre class="highlight"><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## æ”¾å¼ƒ (3)ï¼šå¤„ç†å™¨é—´çš„å¯è§æ€§</span><br><span class="line"></span><br><span class="line">## ä¾‹å­</span><br><span class="line"></span><br></pre>
<p>int x &#x3D; 0, y &#x3D; 0;</p>
<p>void T1() {<br>  x &#x3D; 1; int t &#x3D; y; &#x2F;&#x2F; Store(x); Load(y)<br>  __sync_synchronize();<br>  printf(â€œ%dâ€, t);<br>}</p>
<p>void T2() {<br>  y &#x3D; 1; int t &#x3D; x; &#x2F;&#x2F; Store(y); Load(x)<br>  __sync_synchronize();<br>  printf(â€œ%dâ€, t);<br>}</p>
<pre class="highlight"><span class="line"></span><br><span class="line">éå†æ¨¡å‹å‘Šè¯‰æˆ‘ä»¬ï¼š01, 10, 11</span><br><span class="line"></span><br><span class="line">å®é™…ç»“è®ºåˆ™æ˜¯ï¼š</span><br><span class="line"></span><br><span class="line">![](https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230724140908.png)</span><br><span class="line"></span><br><span class="line">é—®é¢˜å‡ºåœ¨å“ªï¼Ÿ</span><br><span class="line"></span><br><span class="line">- æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„</span><br><span class="line">- Model checker çš„ç»“æœå’Œå®é™…çš„ç»“æœä¸åŒ â†’ å‡è®¾é”™äº†</span><br><span class="line"></span><br><span class="line">## ç°ä»£å¤„ç†å™¨ä¹Ÿæ˜¯ (åŠ¨æ€) ç¼–è¯‘å™¨ï¼</span><br><span class="line"></span><br><span class="line">é”™è¯¯ (ç®€åŒ–) çš„å‡è®¾</span><br><span class="line"></span><br><span class="line">- ä¸€ä¸ª CPU æ‰§è¡Œä¸€æ¡æŒ‡ä»¤åˆ°è¾¾ä¸‹ä¸€çŠ¶æ€</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">å®é™…çš„å®ç°</span><br><span class="line"></span><br><span class="line">- ç”µè·¯å°†è¿ç»­çš„æŒ‡ä»¤ â€œç¼–è¯‘â€ æˆæ›´å°çš„*Î¼*ops</span><br><span class="line">  - RF[9] = load(RF[7] + 400)</span><br><span class="line">  - store(RF[12], RF[13])</span><br><span class="line">  - RF[3] = RF[4] + RF[5]</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">åœ¨ä»»ä½•æ—¶åˆ»ï¼Œå¤„ç†å™¨éƒ½ç»´æŠ¤ä¸€ä¸ª *Î¼*ops çš„ â€œæ± å­â€</span><br><span class="line"></span><br><span class="line">- ä¸ç¼–è¯‘å™¨ä¸€æ ·ï¼Œåš â€œé¡ºåºæ‰§è¡Œâ€ å‡è®¾ï¼šæ²¡æœ‰å…¶ä»–å¤„ç†å™¨ â€œå¹²æ‰°â€</span><br><span class="line">- æ¯ä¸€å‘¨æœŸæ‰§è¡Œå°½å¯èƒ½å¤šçš„ Î¼ops- å¤šè·¯å‘å°„ã€ä¹±åºæ‰§è¡Œã€æŒ‰åºæäº¤</span><br><span class="line"></span><br><span class="line">## æ”¾å¼ƒ (3)ï¼šå¤šå¤„ç†å™¨é—´å†…å­˜è®¿é—®çš„å³æ—¶å¯è§æ€§</span><br><span class="line"></span><br><span class="line">&gt; æ»¡è¶³å•å¤„ç†å™¨ eventual memory consistency çš„æ‰§è¡Œï¼Œåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šå¯èƒ½æ— æ³•åºåˆ—åŒ–ï¼</span><br><span class="line"></span><br><span class="line">å½“ xâ‰ y æ—¶ï¼Œå¯¹ x, y çš„å†…å­˜è¯»å†™å¯ä»¥äº¤æ¢é¡ºåº</span><br><span class="line"></span><br><span class="line">- å®ƒä»¬ç”šè‡³å¯ä»¥åœ¨åŒä¸€ä¸ªå‘¨æœŸé‡Œå®Œæˆ (åªè¦ load/store unit æ”¯æŒ)</span><br><span class="line">- å¦‚æœå†™xå‘ç”Ÿ cache missï¼Œå¯ä»¥è®©è¯»*y*å…ˆæ‰§è¡Œ</span><br><span class="line">  - æ»¡è¶³ â€œå°½å¯èƒ½æ‰§è¡Œ *Î¼*opâ€ çš„åŸåˆ™ï¼Œæœ€å¤§åŒ–å¤„ç†å™¨æ€§èƒ½</span><br><span class="line"></span><br></pre>
<pre><code> # &lt;-----------+
</code></pre>
<p>movl $1, (x)   #   |<br>movl (y), %eax # â€“+</p>
<pre class="highlight"><span class="line"></span><br><span class="line">- åœ¨å¤šå¤„ç†å™¨ä¸Šçš„è¡¨ç°</span><br><span class="line">  - ä¸¤ä¸ªå¤„ç†å™¨åˆ†åˆ«çœ‹åˆ° y=0 å’Œ x=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## å®½æ¾å†…å­˜æ¨¡å‹ (Relaxed/Weak Memory Model)</span><br><span class="line"></span><br><span class="line">&gt; å®½æ¾å†…å­˜æ¨¡å‹çš„ç›®çš„æ˜¯ä½¿å•å¤„ç†å™¨çš„æ‰§è¡Œæ›´é«˜æ•ˆã€‚</span><br><span class="line"></span><br><span class="line">x86 å·²ç»æ˜¯å¸‚é¢ä¸Šèƒ½ä¹°åˆ°çš„ â€œæœ€å¼ºâ€ çš„å†…å­˜æ¨¡å‹äº† </span><br><span class="line"></span><br><span class="line">- è¿™ä¹Ÿæ˜¯ Intel è‡ªå·±ç»™è‡ªå·±åŠ çš„åŒ…è¢±</span><br><span class="line">- çœ‹çœ‹ [ARM/RISC-V](https://research.swtch.com/mem-weak@2x.png) å§ï¼Œæ ¹æœ¬å°±æ˜¯ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿ</span><br><span class="line"></span><br><span class="line">![](https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230724142457.png)</span><br><span class="line"></span><br></pre>
<pre><code>                                X86æ¶æ„
                            æ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„å­˜å‚¨ç©ºé—´
</code></pre>
<pre class="highlight"><span class="line"></span><br><span class="line">![](https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230724142620.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre>
<pre><code>                            ARMæ¶æ„
</code></pre>
<pre class="highlight"><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## å¹¶å‘ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ</span><br><span class="line"></span><br><span class="line">äººç±»æ˜¯ sequential creature</span><br><span class="line"></span><br><span class="line">- ç¼–è¯‘ä¼˜åŒ– + weak memory model å¯¼è‡´éš¾ä»¥ç†è§£çš„å¹¶å‘æ‰§è¡Œ</span><br><span class="line">- æœ‰å¤šéš¾ç†è§£å‘¢ï¼Ÿ</span><br><span class="line">  - [Verifying sequential consistency æ˜¯ NP-å®Œå…¨é—®é¢˜](https://epubs.siam.org/doi/10.1137/S0097539794279614)</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">äººç±»æ˜¯ (ä¸è½»è¨€æ”¾å¼ƒçš„) sequential creature</span><br><span class="line"></span><br><span class="line">- æœ‰é—®é¢˜ï¼Œå°±ä¼šè¯•ç€å»è§£å†³</span><br><span class="line"></span><br><span class="line">- æ‰‹æ®µï¼š</span><br><span class="line"></span><br><span class="line">  â€œå›é€€åˆ°â€ é¡ºåºæ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">  - æ ‡è®°è‹¥å¹²å—ä»£ç ï¼Œä½¿å¾—è¿™äº›ä»£ç ä¸€å®šèƒ½æŒ‰æŸä¸ªé¡ºåºæ‰§è¡Œ</span><br><span class="line">  - ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°åœ¨å—é‡Œè®°å½•æ‰§è¡Œçš„é¡ºåº</span><br><span class="line"></span><br><span class="line">é¡ºåºæ‰§è¡Œâ€”â€”â€”â€”â€”â€”&gt;</span><br><span class="line"></span><br><span class="line">æ’å…¥ â€œç¥ç§˜ä»£ç â€ï¼Œä½¿å¾—æ‰€æœ‰å…¶ä»– â€œç¥ç§˜ä»£ç â€ éƒ½ä¸èƒ½å¹¶å‘</span><br><span class="line"></span><br><span class="line">- ç”± â€œç¥ç§˜ä»£ç â€ é¢†å¯¼ä¸ä¼šå¹¶å‘çš„ä»£ç  (ä¾‹å¦‚ pure functions) æ‰§è¡Œ</span><br><span class="line"></span><br></pre>
<p>void Tsum() {<br>  stop_the_world();<br>  &#x2F;&#x2F; ä¸´ç•ŒåŒº critical section<br>  sum++;<br>  resume_the_world();<br>}</p>
<pre class="highlight"><span class="line"></span><br><span class="line">å¹¶éæ‰€æœ‰å—éƒ½éœ€è¦ â€œstop_the_worldâ€,å¦åˆ™é‚£å°±å’Œæˆ‘ä»¬çš„åˆè¡·ï¼ˆåˆ©ç”¨å¤šä¸ªçº¿ç¨‹åŠ é€Ÿé—®é¢˜å¤„ç†ï¼‰è¿èƒŒäº†ã€‚</span><br><span class="line"></span><br><span class="line">éœ€è¦å…±äº«èµ„æºçš„å—æ‰éœ€è¦ stop the worldï¼Œç±»ä¼¼äºåœ¨è®¿é—®åå°†èµ„æºé”æ­»ï¼Œé˜²æ­¢å…¶ä»–å—è®¿é—®ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## å¤±è´¥çš„å°è¯•</span><br><span class="line"></span><br></pre>
<p>int locked &#x3D; UNLOCK;</p>
<p>void critical_section() {<br>retry:<br>  if (locked !&#x3D; UNLOCK) {<br>    goto retry;<br>  }<br>  locked &#x3D; LOCK;</p>
<p>  &#x2F;&#x2F; critical section</p>
<p>  locked &#x3D; UNLOCK;<br>}</p>
<pre class="highlight"><span class="line"></span><br><span class="line">å’Œ â€œå±±å¯¨æ”¯ä»˜å®â€ å®Œå…¨ä¸€æ ·çš„é”™è¯¯</span><br><span class="line"></span><br><span class="line">- å¹¶å‘ç¨‹åºä¸èƒ½ä¿è¯ load + store çš„åŸå­æ€§</span><br><span class="line"></span><br><span class="line">å³å¯èƒ½å­˜åœ¨ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œlock!=UNLOCKè¯­å¥ï¼Œä¸€æ ·å­˜åœ¨å†²çª</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹ä¸çº¿ç¨‹ä¹‹é—´äº’ç›¸çœ‹ä¸åˆ°æ˜¯å¦æ­£åœ¨æ‰§è¡Œunlockæ“ä½œï¼Œå³åŸå­æ€§æ— æ³•ä¿è¯</span><br><span class="line"></span><br><span class="line">ç‰©ç†ä¸–ç•Œä¸­ï¼Œäººå»è§£é”ä¸€ä¸ªé—¨ï¼Œé—¨æ— æ³•å…è®¸ä¸¤ä¸ªäººå»è§£é”ï¼Œå› ä¸ºäººå¾ˆâ€œå¤§â€</span><br><span class="line"></span><br><span class="line">###  æ›´ä¸¥è‚ƒåœ°å°è¯•ï¼šç¡®å®šå‡è®¾ã€è®¾è®¡ç®—æ³•</span><br><span class="line"></span><br><span class="line">å‡è®¾ï¼šå†…å­˜çš„è¯»/å†™å¯ä»¥ä¿è¯é¡ºåºã€åŸå­å®Œæˆ</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  val = atomic_load(ptr)</span><br></pre>

<ul>
<li><p>çœ‹ä¸€çœ¼æŸä¸ªåœ°æ–¹çš„å­—æ¡ (åªèƒ½çœ‹åˆ°ç¬é—´çš„å­—)</p>
</li>
<li><p>åˆšçœ‹å®Œå°±å¯èƒ½è¢«æ”¹æ‰</p>
</li>
<li><p>&#96;&#96;&#96;<br>atomic_store(ptr, val)</p>
<pre class="highlight"><span class="line"></span><br><span class="line">  - å¯¹åº”å¾€æŸä¸ªåœ°æ–¹ â€œè´´ä¸€å¼ çº¸æ¡â€ (å¿…é¡»é—­çœ¼ç›²è´´)</span><br><span class="line">  - è´´å®Œä¸€ç¬é—´å°±å¯èƒ½è¢«åˆ«äººè¦†ç›–</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">å¯¹åº”äº model checker</span><br><span class="line"></span><br><span class="line">- æ¯ä¸€è¡Œå¯ä»¥æ‰§è¡Œä¸€æ¬¡å…¨å±€å˜é‡è¯»æˆ–å†™</span><br><span class="line">- æ¯ä¸ªæ“ä½œæ‰§è¡Œä¹‹åéƒ½å‘ç”Ÿ `sys_sched()`</span><br><span class="line"></span><br><span class="line">## æ­£ç¡®æ€§ä¸æ˜çš„å¥‡æ€ªå°è¯• (Peterson ç®—æ³•)</span><br><span class="line"></span><br><span class="line">A å’Œ B äº‰ç”¨å•æ‰€çš„åŒ…å¢</span><br><span class="line"></span><br><span class="line">- æƒ³è¿›å…¥åŒ…å¢ä¹‹å‰ï¼ŒA/B éƒ½é¦–å…ˆä¸¾èµ·è‡ªå·±çš„æ——å­</span><br><span class="line"></span><br><span class="line">  - A å¾€å•æ‰€é—¨ä¸Šè´´ä¸Š â€œB æ­£åœ¨ä½¿ç”¨â€ çš„æ ‡ç­¾</span><br><span class="line">  - B å¾€å•æ‰€é—¨ä¸Šè´´ä¸Š â€œA æ­£åœ¨ä½¿ç”¨â€ çš„æ ‡ç­¾</span><br><span class="line"></span><br><span class="line">- ç„¶åï¼Œ</span><br><span class="line"></span><br><span class="line">  å¦‚æœå¯¹æ–¹ä¸¾ç€æ——ï¼Œä¸”é—¨ä¸Šçš„åå­—æ˜¯å¯¹æ–¹</span><br><span class="line"></span><br><span class="line">  ï¼Œç­‰å¾…</span><br><span class="line"></span><br><span class="line">  - å¦åˆ™å¯ä»¥è¿›å…¥åŒ…å¢</span><br><span class="line"></span><br><span class="line">- å‡ºåŒ…å¢åï¼Œæ”¾ä¸‹è‡ªå·±çš„æ——å­ (å®Œå…¨ä¸ç®¡é—¨ä¸Šçš„æ ‡ç­¾)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## ä¹ é¢˜ï¼šè¯æ˜ Peterson ç®—æ³•æ­£ç¡®ï¼Œæˆ–ç»™å‡ºåä¾‹</span><br><span class="line"></span><br><span class="line">è¿›å…¥ä¸´ç•ŒåŒºçš„æƒ…å†µ</span><br><span class="line"></span><br><span class="line">- å¦‚æœåªæœ‰ä¸€ä¸ªäººä¸¾æ——ï¼Œä»–å°±å¯ä»¥ç›´æ¥è¿›å…¥</span><br><span class="line">- å¦‚æœä¸¤ä¸ªäººåŒæ—¶ä¸¾æ——ï¼Œç”±å•æ‰€é—¨ä¸Šçš„æ ‡ç­¾å†³å®šè°è¿›</span><br><span class="line">  - æ‰‹å¿« ğŸˆ¶ï¸ (è¢«å¦ä¸€ä¸ªäººçš„æ ‡ç­¾è¦†ç›–)ã€æ‰‹æ…¢ ğŸˆš</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">ä¸€äº›å…·ä½“çš„ç»†èŠ‚æƒ…å†µ</span><br><span class="line"></span><br><span class="line">- A çœ‹åˆ° B æ²¡æœ‰ä¸¾æ——</span><br><span class="line">  - B ä¸€å®šä¸åœ¨ä¸´ç•ŒåŒº</span><br><span class="line">  - æˆ–è€… B æƒ³è¿›ä½†è¿˜æ²¡æ¥å¾—åŠæŠŠ â€œA æ­£åœ¨ä½¿ç”¨â€ è´´åœ¨é—¨ä¸Š</span><br><span class="line">- A çœ‹åˆ° B ä¸¾æ——å­</span><br><span class="line">  - A ä¸€å®šå·²ç»æŠŠæ——å­ä¸¾èµ·æ¥äº†</span><br><span class="line">  - (*!@^#*&amp;!%^(&amp;^!@%#</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## â€œPush-buttonâ€ Verification ğŸ–</span><br><span class="line"></span><br><span class="line">&gt; æˆ‘ä»¬ (åœ¨å®Œå…¨ä¸ç†è§£ç®—æ³•çš„å‰æä¸‹) è¯æ˜äº† Sequential å†…å­˜æ¨¡å‹ä¸‹ Peterson&#x27;s Protocol çš„ Safetyã€‚å®ƒèƒ½å¤Ÿå®ç°äº’æ–¥ã€‚</span><br><span class="line"></span><br><span class="line">å¹¶å‘ç¼–ç¨‹æ¯”å¤§å®¶æƒ³è±¡å¾—å›°éš¾</span><br><span class="line"></span><br><span class="line">- æ„Ÿå—ä¸€ä¸‹ [Dekker&#x27;s Algorithm](https://series1.github.io/blog/dekkers-algorithm/)</span><br><span class="line">- â€œ[Myths about the mutual exclusion problem](https://zoo.cs.yale.edu/classes/cs323/doc/Peterson.pdf)â€ (IPL, 1981)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## è‡ªåŠ¨éå†çŠ¶æ€ç©ºé—´çš„ä¹è¶£</span><br><span class="line"></span><br><span class="line">å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå›ç­”æ›´å¤šé—®é¢˜</span><br><span class="line"></span><br><span class="line">- å¦‚æœç»“æŸåæŠŠé—¨ä¸Šçš„å­—æ¡æ’•æ‰ï¼Œç®—æ³•è¿˜æ­£ç¡®å—ï¼Ÿ</span><br><span class="line">  - åœ¨æ”¾ä¸‹æ——å­ä¹‹å‰æ’•</span><br><span class="line">  - åœ¨æ”¾ä¸‹æ——å­ä¹‹åæ’•</span><br><span class="line">- å¦‚æœå…ˆè´´æ ‡ç­¾å†ä¸¾æ——ï¼Œç®—æ³•è¿˜æ­£ç¡®å—ï¼Ÿ</span><br><span class="line">- æˆ‘ä»¬æœ‰ä¸¤ä¸ª â€œæŸ¥çœ‹â€ çš„æ“ä½œ</span><br><span class="line">  - çœ‹å¯¹æ–¹çš„æ——æœ‰æ²¡æœ‰ä¸¾èµ·æ¥</span><br><span class="line">  - çœ‹é—¨ä¸Šçš„è´´çº¸æ˜¯ä¸æ˜¯è‡ªå·±</span><br><span class="line">  - è¿™ä¸¤ä¸ªæ“ä½œçš„é¡ºåºå½±å“ç®—æ³•çš„æ­£ç¡®æ€§å—ï¼Ÿ</span><br><span class="line">- æ˜¯å¦å­˜åœ¨ â€œä¸¤ä¸ªäººè°éƒ½æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºâ€ (liveness)ã€â€œå¯¹æŸä¸€æ–¹ä¸å…¬å¹³â€ (fairness) ç­‰è¡Œä¸ºï¼Ÿ</span><br><span class="line">  - éƒ½è½¬æ¢æˆå›¾ (çŠ¶æ€ç©ºé—´) ä¸Šçš„éå†é—®é¢˜äº†ï¼</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## Model Checker å’Œè‡ªåŠ¨åŒ–</span><br><span class="line"></span><br><span class="line">ç”µè„‘ä¸ºä»€ä¹ˆå« â€œç”µè„‘â€</span><br><span class="line"></span><br><span class="line">- å°±æ˜¯å› ä¸ºå®ƒèƒ½æ›¿ä»£éƒ¨åˆ†äººç±»çš„æ€ç»´æ´»åŠ¨</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">å›å¿†ï¼šæ¯ä¸ªç­ä¸Šéƒ½æœ‰ä¸€ä¸ªç¬”è®°å’Œè‰ç¨¿çº¸éƒ½å·¥å·¥æ•´æ•´çš„ Ta</span><br><span class="line"></span><br><span class="line">- è€å¸ˆï¼šå¸ƒç½®ä½œä¸šç”»çŠ¶æ€å›¾</span><br><span class="line"></span><br><span class="line">  - Taï¼šè®¤è®¤çœŸçœŸé»˜é»˜ç”»å®Œ</span><br><span class="line"></span><br><span class="line">    - å·¥æ•´çš„ç¬”è®°å¯ä»¥å¯å‘æ€ç»´</span><br><span class="line">    - ä½† scale out éå¸¸å›°éš¾</span><br><span class="line"></span><br><span class="line">  - æˆ‘ï¼šçƒ¦æ­»äº†ï¼åŠ³èµ„ä¸å¹²äº†ï¼ç©æ¸¸æˆå»äº†ï¼</span><br><span class="line"></span><br><span class="line">    - è®¡ç®—æ€ç»´</span><br><span class="line"></span><br><span class="line">      ï¼šå†™ä¸ªç¨‹åº (model checker) æ¥è¾…åŠ©</span><br><span class="line"></span><br><span class="line">      - ä»»ä½•æœºæ¢°çš„æ€ç»´æ´»åŠ¨éƒ½å¯ä»¥ç”¨è®¡ç®—æœºæ›¿ä»£</span><br><span class="line">      - AI è¿˜å¯ä»¥æ›¿ä»£å¯å‘å¼/ç»éªŒå¼çš„å†³ç­–</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## ä»æ¨¡å‹å›åˆ°ç°å®â€¦â€¦</span><br><span class="line"></span><br><span class="line">å›åˆ°æˆ‘ä»¬çš„å‡è®¾ (ä½“ç°åœ¨æ¨¡å‹)</span><br><span class="line"></span><br><span class="line">- Atomic load &amp; store</span><br><span class="line">  - è¯»/å†™å•ä¸ªå…¨å±€å˜é‡æ˜¯ â€œåŸå­ä¸å¯åˆ†å‰²â€ çš„</span><br><span class="line">  - ä½†è¿™ä¸ªå‡è®¾åœ¨ç°ä»£å¤šå¤„ç†å™¨ä¸Šå¹¶ä¸æˆç«‹</span><br><span class="line">- æ‰€ä»¥å®é™…ä¸ŠæŒ‰ç…§æ¨¡å‹ç›´æ¥å†™ Peterson ç®—æ³•åº”è¯¥æ˜¯é”™çš„ï¼Ÿ</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">â€œå®ç°æ­£ç¡®çš„ Peterson ç®—æ³•â€ æ˜¯åˆç†éœ€æ±‚ï¼Œå®ƒä¸€å®šèƒ½å®ç°</span><br><span class="line"></span><br><span class="line">- Compiler barrier/volatile ä¿è¯ä¸è¢«ä¼˜åŒ–çš„å‰æä¸‹</span><br><span class="line"></span><br><span class="line">  - å¤„ç†å™¨æä¾›ç‰¹æ®ŠæŒ‡ä»¤ä¿è¯å¯è§æ€§</span><br><span class="line"></span><br><span class="line">  - ç¼–è¯‘å™¨æä¾›</span><br><span class="line"></span><br></pre>
<p>  __sync_synchronize()</p>
  <pre class="highlight"><span class="line"></span><br><span class="line">    å‡½æ•°</span><br><span class="line"></span><br><span class="line">    - x86: `mfence`; ARM: `dmb ish`; RISC-V: `fence rw, rw`</span><br><span class="line">    - åŒæ—¶å«æœ‰ä¸€ä¸ª compiler barrier</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å¦‚ä½•éªŒè¯petersonç®—æ³•çš„æ­£ç¡®æ€§ï¼Ÿ</span><br><span class="line"></span><br><span class="line">å›åˆ°â€œå±±å¯¨æ”¯ä»˜å®â€çš„å°è¯•ï¼Œå¦‚æœä½ â€œstop_the_worldâ€çš„å°è¯•å¹¶ä¸å®Œç¾ï¼Œä¼šå‡ºç°å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥çš„æƒ…å†µï¼Œå°±å¯åœ¨è¿™ä¸ªæ‰§è¡Œè¿‡ç¨‹ä¸­é€šè¿‡è®¡æ•°å™¨æ¥åˆ¤æ–­æ˜¯å¦æœ‰è¿™ä¸ªæƒ…å†µå‘ç”Ÿï¼Œè¿›è€Œåˆ¤æ–­Petersonç®—æ³•çš„æ­£ç¡®æ€§</span><br><span class="line"></span><br><span class="line">![](https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230724231619.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Peterson ç®—æ³•ï¼šC ä»£ç å®ç°æ¼”ç¤º</span><br><span class="line"></span><br><span class="line">- ä¸€äº›æœ‰è¶£çš„é—®é¢˜</span><br><span class="line">  - Compiler barrier èƒ½å¤Ÿç”¨å—ï¼Ÿ</span><br><span class="line">  - å“ªäº›åœ°æ–¹çš„ barrier æ˜¯ä¸å¯å°‘çš„ï¼Ÿ</span><br><span class="line">- æµ‹è¯•åªèƒ½è¯æ˜ â€œæœ‰é—®é¢˜â€ï¼Œä¸èƒ½è¯æ˜ â€œæ²¡é—®é¢˜â€</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">ç¼–è¯‘å™¨åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ</span><br><span class="line"></span><br><span class="line">- æ¨èï¼š</span><br><span class="line"></span><br><span class="line">  godbolt.org</span><br><span class="line"></span><br><span class="line">  ï¼Œä½ ä¸ç”¨è£…é‚£äº› cross compiler äº†</span><br><span class="line"></span><br><span class="line">  - ä½ ç”šè‡³å¯ä»¥çœ‹åˆ° compiler barrier æ˜¯å¦‚ä½•åœ¨ä¼˜åŒ–ä¸­ä¼ é€’çš„</span><br><span class="line">    - å†ä¸€æ¬¡ï¼šè‡ªåŠ¨åŒ– &amp; å¯è§†åŒ–çš„æ„ä¹‰</span><br><span class="line">  - ä¸æ‡‚å¯ä»¥æŠŠä»£ç ç›´æ¥æ‰”ç»™ ChatGPT</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line">#include &quot;thread.h&quot;</span><br><span class="line"></span><br><span class="line">#define A 1</span><br><span class="line">#define B 2</span><br><span class="line"></span><br><span class="line">#define BARRIER __sync_synchronize()</span><br><span class="line"></span><br><span class="line">atomic_int nested;</span><br><span class="line">atomic_long count;</span><br><span class="line"></span><br><span class="line">void critical_section() &#123;</span><br><span class="line">  long cnt = atomic_fetch_add(&amp;count, 1);</span><br><span class="line">  int i = atomic_fetch_add(&amp;nested, 1) + 1;</span><br><span class="line">  if (i != 1) &#123;</span><br><span class="line">    printf(&quot;%d threads in the critical section @ count=%ld\n&quot;, i, cnt);</span><br><span class="line">    assert(0);</span><br><span class="line">  &#125;</span><br><span class="line">  atomic_fetch_add(&amp;nested, -1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int volatile x = 0, y = 0, turn;</span><br><span class="line"></span><br><span class="line">void TA() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    x = 1;                   BARRIER;</span><br><span class="line">    turn = B;                BARRIER; // &lt;- this is critcal for x86</span><br><span class="line">    while (1) &#123;</span><br><span class="line">      if (!y) break;         BARRIER;</span><br><span class="line">      if (turn != B) break;  BARRIER;</span><br><span class="line">    &#125;</span><br><span class="line">    critical_section();</span><br><span class="line">    x = 0;                   BARRIER;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void TB() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    y = 1;                   BARRIER;</span><br><span class="line">    turn = A;                BARRIER;</span><br><span class="line">    while (1) &#123;</span><br><span class="line">      if (!x) break;         BARRIER;</span><br><span class="line">      if (turn != A) break;  BARRIER;</span><br><span class="line">    &#125;</span><br><span class="line">    critical_section();</span><br><span class="line">    y = 0;                   BARRIER;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  create(TA);</span><br><span class="line">  create(TB);</span><br><span class="line">&#125;</span><br></pre></li>
</ul>
<p>__sync_synchronize();</p>
<p><a target="_blank" rel="noopener" href="https://godbolt.org/">https://godbolt.org/</a></p>
<pre class="highlight"><span class="line">foo():</span><br><span class="line">        push    rbp</span><br><span class="line">        mov     rbp, rsp</span><br><span class="line">        lock or QWORD PTR [rsp], 0</span><br><span class="line">        nop</span><br><span class="line">        pop     rbp</span><br><span class="line">        ret</span><br></pre>



<p>Petersonç®—æ³•çš„å®ç°åŸç†ï¼š å†…å­˜çš„è¯»\å†™æ˜¯åŸå­ä¸å¯åˆ†å‰²çš„ï¼Œä½†åœ¨ç°ä»£å¤šå¤„ç†ç»“æ„ä¸Šå¹¶ä¸æˆç«‹</p>
<p>åŸå­æŒ‡ä»¤ï¼š</p>
<p>æ™®é€šçš„å˜é‡è¯»å†™åœ¨ç¼–è¯‘å™¨+å¤„ç†å™¨çš„åŒé‡ä¼˜åŒ–ä¸‹è¡Œä¸ºå˜å¾—å¤æ‚</p>
<p>åœ¨è®¡ç®—æœºä¸–ç•Œçš„å¤šçº¿ç¨‹å¤„ç†ä¸­ï¼Œå˜é‡è¯»å†™éšæ—¶æœ‰å¯èƒ½ä¼šè¢«æ‰“æ–­ï¼Œè€Œéç‰©ç†ä¸–ç•Œçš„ä¸€è‡´ä¸è¿è´¯ï¼ˆå•çº¿ç¨‹ï¼‰ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼šç¼–è¯‘å™¨å’Œç¡¬ä»¶å…±åŒæä¾›ä¸å¯ä¼˜åŒ–ã€ä¸å¯æ‰“æ–­çš„æŒ‡ä»¤</p>
<ul>
<li>â€œåŸå­æŒ‡ä»¤â€ + compiler barrier</li>
</ul>
<h2 id="å®ç°æ­£ç¡®çš„æ±‚å’Œ"><a href="#å®ç°æ­£ç¡®çš„æ±‚å’Œ" class="headerlink" title="å®ç°æ­£ç¡®çš„æ±‚å’Œ"></a>å®ç°æ­£ç¡®çš„æ±‚å’Œ</h2><pre class="highlight"><span class="line">for (int i = 0; i &lt; N; i++)</span><br><span class="line">  asm volatile(&quot;lock incq %0&quot; : &quot;+m&quot;(sum));</span><br></pre>

<p>â€œBus lockâ€â€”â€”ä» 80386 å¼€å§‹å¼•å…¥ (bus control signal)</p>
<p>â€æ€»çº¿é”â€œ</p>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230724235431.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230724235431.png"></p>
<p>åŸå­æŒ‡ä»¤ï¼šå°†ä¸–ç•Œåˆ†å‰²æˆåœæ­¢ä¸ä¸åœæ­¢çš„ä¸¤éƒ¨åˆ†ï¼Œåœæ­¢çš„æ—¶é—´åªæœ‰ä»–èƒ½è®¿é—®è¿™ä¸€å—å†…å­˜</p>
<pre class="highlight"><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;thread.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N 100000000</span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">atomic_inc</span><span class="params">(<span class="type">long</span> *ptr)</span> &#123;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="string">&quot;lock incq %0&quot;</span>  <span class="comment">// Atomic + memory fence</span></span></span><br><span class="line"><span class="params">    : <span class="string">&quot;+m&quot;</span>(*ptr)</span></span><br><span class="line"><span class="params">    :</span></span><br><span class="line"><span class="params">    : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Tsum</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="type">atomic_inc</span>(&amp;sum);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  create(Tsum);</span><br><span class="line">  create(Tsum);</span><br><span class="line">  join();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;sum = %ld\n&quot;</span>, sum);</span><br><span class="line">&#125;</span><br></pre>







<h2 id="äº’æ–¥é—®é¢˜ï¼šå®šä¹‰"><a href="#äº’æ–¥é—®é¢˜ï¼šå®šä¹‰" class="headerlink" title="äº’æ–¥é—®é¢˜ï¼šå®šä¹‰"></a>äº’æ–¥é—®é¢˜ï¼šå®šä¹‰</h2><p>äº’æ–¥ (mutual exclusion)ï¼Œâ€œäº’ç›¸æ’æ–¥â€</p>
<ul>
<li>å®ç° <code>lock_t</code> æ•°æ®ç»“æ„å’Œ <code>lock/unlock</code> API:</li>
</ul>
<pre class="highlight"><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125; <span class="type">lock_t</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">lock_t</span> *lk)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">(<span class="type">lock_t</span> *lk)</span>;</span><br></pre>

<hr>
<p>ä¸€æŠŠ â€œæ’ä»–æ€§â€ çš„é”â€”â€”å¯¹äºé”å¯¹è±¡ <code>lk</code></p>
<ul>
<li>å¦‚æœæŸä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œåˆ™å…¶ä»–çº¿ç¨‹çš„ <code>lock</code> ä¸èƒ½è¿”å› (Safety)</li>
<li>åœ¨å¤šä¸ªçº¿ç¨‹æ‰§è¡Œ <code>lock</code> æ—¶ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªå¯ä»¥è¿”å› (Liveness)</li>
<li>èƒ½æ­£ç¡®å¤„ç†å¤„ç†å™¨ä¹±åºã€å®½æ¾å†…å­˜æ¨¡å‹å’Œç¼–è¯‘ä¼˜åŒ–</li>
</ul>
<h2 id="äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•"><a href="#äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•" class="headerlink" title="äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•"></a>äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•</h2><p>Peterson ç®—æ³•</p>
<ul>
<li>åŒ…é—´ã€æ——å­å’Œé—¨ä¸Šçš„å­—æ¡</li>
<li>å‡è®¾ atomic load&#x2F;store<ul>
<li>å®ç°è¿™ä¸ªå‡è®¾ä¹Ÿä¸æ˜¯éå¸¸å®¹æ˜“çš„ (<a target="_blank" rel="noopener" href="https://jyywiki.cn/pages/OS/2023/c/peterson.c">peterson.c</a>)</li>
</ul>
</li>
</ul>
<hr>
<p>å› æ­¤ï¼Œå‡è®¾å¾ˆé‡è¦</p>
<ul>
<li>ä¸èƒ½åŒæ—¶è¯»&#x2F;å†™å…±äº«å†…å­˜ (1960s) ä¸æ˜¯ä¸€ä¸ªå¥½çš„å‡è®¾<ul>
<li>Load (ç¯é¡¾å››å‘¨) çš„æ—¶å€™ä¸èƒ½å†™ï¼Œâ€œçœ‹ä¸€çœ¼å°±æŠŠçœ¼ç›é—­ä¸Šâ€</li>
<li>Store (æ”¹å˜ç‰©ç†ä¸–ç•ŒçŠ¶æ€) çš„æ—¶å€™ä¸èƒ½è¯»ï¼Œâ€œé—­ç€çœ¼ç›åŠ¨æ‰‹â€</li>
<li>è¿™æ˜¯ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾<ul>
<li>æ›´å–œæ¬¢ç›´è§‚ã€ç®€å•ã€ç²—æš´ (ç¨³å®š)ã€æœ‰æ•ˆçš„è§£å†³æ–¹æ³•</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾"><a href="#å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾" class="headerlink" title="å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾"></a>å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾</h2><p>å…è®¸ä½¿ç”¨ä½¿æˆ‘ä»¬å¯ä»¥ä¸ç®¡ä¸€åˆ‡éº»çƒ¦äº‹çš„åŸå­æŒ‡ä»¤</p>
<pre class="highlight"><span class="line"><span class="type">void</span> <span class="title function_">atomic_inc</span><span class="params">(<span class="type">long</span> *ptr)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">atomic_xchg</span><span class="params">(<span class="type">int</span> val, <span class="type">int</span> *ptr)</span>;</span><br></pre>

<hr>
<p>çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œä½†å‡è®¾ï¼š</p>
<ul>
<li>åŒ…å«ä¸€ä¸ªåŸå­æŒ‡ä»¤<ul>
<li>æŒ‡ä»¤çš„æ‰§è¡Œä¸èƒ½è¢«æ‰“æ–­</li>
</ul>
</li>
<li>åŒ…å«ä¸€ä¸ª compiler barrier<ul>
<li>æ— è®ºä½•ç§ä¼˜åŒ–éƒ½ä¸å¯è¶Šè¿‡æ­¤å‡½æ•°</li>
</ul>
</li>
<li>åŒ…å«ä¸€ä¸ª memory fence<ul>
<li>ä¿è¯å¤„ç†å™¨åœ¨ stop-the-world å‰æ‰€æœ‰å¯¹å†…å­˜çš„ store éƒ½ â€œç”Ÿæ•ˆâ€</li>
<li>å³å¯¹ resume-the-world ä¹‹åçš„ load å¯è§</li>
</ul>
</li>
</ul>
<h2 id="Atomic-Exchange-å®ç°"><a href="#Atomic-Exchange-å®ç°" class="headerlink" title="Atomic Exchange å®ç°"></a>Atomic Exchange å®ç°</h2><pre class="highlight"><span class="line"><span class="type">int</span> <span class="title function_">xchg</span><span class="params">(<span class="type">int</span> <span class="keyword">volatile</span> *ptr, <span class="type">int</span> newval)</span> &#123;</span><br><span class="line">  <span class="type">int</span> result;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="comment">// æŒ‡ä»¤è‡ªå¸¦ memory barrier</span></span></span><br><span class="line"><span class="params">    <span class="string">&quot;lock xchgl %0, %1&quot;</span></span></span><br><span class="line"><span class="params">    : <span class="string">&quot;+m&quot;</span>(*ptr), <span class="string">&quot;=a&quot;</span>(result)</span></span><br><span class="line"><span class="params">    : <span class="string">&quot;1&quot;</span>(newval)</span></span><br><span class="line"><span class="params">    <span class="comment">// Compiler barrier</span></span></span><br><span class="line"><span class="params">    : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre>

<p>&#x2F;&#x2F;ä¸ç”¨å¤ªåœ¨æ„è¿™ä¸ªå®ç°ï¼Œå®åœ¨æ˜¯å¥½éš¾æ‡‚â€¦</p>
<p>memory-&gt; compile barrier</p>
<p>lock       -&gt; memory barrier</p>
<p>&#x2F;&#x2F;OSTEPä¸Šçš„Cä¼ªä»£ç </p>
<pre class="highlight"><span class="line"><span class="type">int</span> <span class="title function_">TestAndSet</span><span class="params">(<span class="type">int</span> *old_ptr, <span class="type">int</span> new)</span> &#123;</span><br><span class="line"><span class="type">int</span> old = *old_ptr; <span class="comment">// fetch old value at old_ptr</span></span><br><span class="line">*old_ptr = new; <span class="comment">// store &#x27;new&#x27; into old_ptr</span></span><br><span class="line"><span class="keyword">return</span> old; <span class="comment">// return the old value</span></span><br><span class="line">&#125;</span><br></pre>

<p>è·å–å€¼ï¼Œå­˜å‚¨ï¼Œè¿”å›æ—§å€¼</p>
<pre class="highlight"><span class="line"><span class="comment">//æ¯”è¾ƒæ˜¾è€Œæ˜“è§çš„å®ç°è‡ªæ—‹é”é”çš„lockå’Œunlockå‡½æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">lock_t</span> *lock)</span> &#123;</span><br><span class="line"> <span class="keyword">while</span> (TestAndSet(&amp;lock-&gt;flag, <span class="number">1</span>) == <span class="number">1</span>)</span><br><span class="line"> ; <span class="comment">// spin-wait (do nothing)</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="type">void</span> <span class="title function_">unlock</span><span class="params">(<span class="type">lock_t</span> *lock)</span> &#123;</span><br><span class="line"> lock-&gt;flag = <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre>

<pre class="highlight"><span class="line"><span class="comment">//é¦–å…ˆå‡è®¾ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼Œè°ƒç”¨lock()ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰é”ï¼Œæ‰€ä»¥flag æ˜¯0ã€‚å½“è°ƒç”¨TestAndSet(flag, 1)æ–¹æ³•ï¼Œè¿”å›0ï¼Œçº¿ç¨‹ä¼šè·³å‡ºwhileå¾ªç¯ï¼Œè·å–é”ã€‚åŒæ—¶ä¹Ÿä¼šåŸå­çš„è®¾ç½®flag ä¸º1ï¼Œæ ‡å¿—é”å·²ç»è¢«æŒæœ‰ã€‚å½“çº¿ç¨‹ç¦»å¼€ä¸´ç•ŒåŒºï¼Œè°ƒç”¨unlock()å°†flag æ¸…ç†ä¸º0ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¬¬äºŒç§åœºæ™¯æ˜¯ï¼Œå½“æŸä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰é”ï¼ˆå³flag ä¸º1ï¼‰ã€‚æœ¬çº¿ç¨‹è°ƒç”¨lock()ï¼Œç„¶åè°ƒç”¨TestAndSet(flag, 1)ï¼Œè¿™ä¸€æ¬¡è¿”å›1ã€‚åªè¦å¦ä¸€ä¸ªçº¿ç¨‹ä¸€ç›´æŒæœ‰é”ï¼ŒTestAndSet()ä¼šé‡å¤è¿”å›1ï¼Œæœ¬çº¿ç¨‹ä¼šä¸€ç›´è‡ªæ—‹ã€‚å½“flag ç»ˆäºè¢«æ”¹ä¸º0ï¼Œæœ¬çº¿ç¨‹ä¼šè°ƒç”¨TestAndSet()ï¼Œè¿”å›0 å¹¶ä¸”åŸå­åœ°è®¾ç½®ä¸º1ï¼Œä»è€Œè·å¾—é”ï¼Œè¿›å…¥ä¸´ç•ŒåŒºã€‚</span></span><br></pre>



<h2 id="å®ç°äº’æ–¥ï¼šåšé¢˜å®¶-v-s-ç§‘å­¦å®¶"><a href="#å®ç°äº’æ–¥ï¼šåšé¢˜å®¶-v-s-ç§‘å­¦å®¶" class="headerlink" title="å®ç°äº’æ–¥ï¼šåšé¢˜å®¶ v.s. ç§‘å­¦å®¶"></a>å®ç°äº’æ–¥ï¼šåšé¢˜å®¶ v.s. ç§‘å­¦å®¶</h2><pre class="highlight"><span class="line">void lock(lock_t *lk);</span><br><span class="line">void unlock(lock_t *lk);</span><br></pre>

<p>åšé¢˜å®¶ï¼šæ‹¿åˆ°é¢˜å°±å¼€å§‹æ’åˆ—ç»„åˆ</p>
<ul>
<li>ç†Ÿç»ƒå¾—è®©äººå¿ƒç–¼<ul>
<li>å¦‚æœé•¿ä¹…çš„è®­ç»ƒéƒ½æ˜¯ â€œå¿…é¡»åœ¨è§„å®šçš„æ—¶é—´å†…æ­£ç¡®è§£å‡ºé—®é¢˜â€ï¼Œé‚£ä¹ˆæµªè´¹æ—¶é—´çš„æ€è€ƒè‡ªç„¶å°±å°‘äº†</li>
</ul>
</li>
</ul>
<hr>
<p>ç§‘å­¦å®¶ï¼šè€ƒè™‘æ›´å¤šæ›´æ ¹æœ¬çš„é—®é¢˜</p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥è®¾è®¡å‡ºæ€æ ·çš„åŸå­æŒ‡ä»¤ï¼Ÿ<ul>
<li>å®ƒä»¬çš„è¡¨è¾¾èƒ½åŠ›å¦‚ä½•ï¼Ÿ</li>
</ul>
</li>
<li>è®¡ç®—æœºç¡¬ä»¶å¯ä»¥æä¾›æ¯” â€œä¸€æ¬¡ load&#x2F;storeâ€ æ›´å¼ºçš„åŸå­æ€§å—ï¼Ÿ<ul>
<li>å¦‚æœç¡¬ä»¶å¾ˆå›°éš¾ï¼Œè½¯ä»¶&#x2F;ç¼–è¯‘å™¨å¯ä»¥ä¹ˆï¼Ÿ</li>
</ul>
</li>
</ul>
<h2 id="å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”"><a href="#å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”" class="headerlink" title="å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”"></a>å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</h2><pre class="highlight"><span class="line">int table = YES;</span><br><span class="line"></span><br><span class="line">void lock() &#123;</span><br><span class="line">retry:</span><br><span class="line">  int got = xchg(&amp;table, NOPE);</span><br><span class="line">  if (got == NOPE)</span><br><span class="line">    goto retry;</span><br><span class="line">  assert(got == YES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void unlock() &#123;</span><br><span class="line">  xchg(&amp;table, YES);  // ä¸ºä»€ä¹ˆä¸æ˜¯ table = YES; ?</span><br><span class="line">&#125;</span><br></pre>

<p>(åœ¨ model checker ä¸­æ£€æŸ¥)</p>
<p>1ã€è‹¥åœ¨lockå’Œunlockçš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹crashäº†ï¼Œé‚£ä¹ˆYESå°±æ°¸è¿œæ¶ˆå¤±äº†ï¼Œçº¿ç¨‹å°±å‘ç”Ÿäº†æ­»é”</p>
<p>trickï¼šc++çš„ææ„å‡½æ•°å¯ä»¥åšåˆ°æ„é€ æ—¶ä¸Šé”ï¼Œé€€å‡ºæ—¶å»é”ï¼Œèƒ½å¤Ÿä¸€å®šç¨‹åº¦ä¸Šé¿å…åœ¨lockå’Œunlockæ—¶ä¸ç”šå†™äº†returnè¯­å¥é€ æˆçº¿ç¨‹æ­»é”ï¼ˆreturnæ—¶çº¿ç¨‹ç»“æŸï¼Œè‡ªåŠ¨è°ƒç”¨ææ„å‡½æ•°ï¼‰</p>
<p>2ã€table &#x3D; YESï¼Ÿ ä¸ºäº†é˜²æ­¢è‡ªåŠ¨ä¼˜åŒ–å’ŒæŸäº›å¥‡æ€ªçš„â€œbugâ€ï¼Œæœ€ä¿é™©ä»¥åŠæœ€å®‰å…¨çš„æ–¹æ³•è¿˜æ˜¯è°ƒç”¨unlockè¯­å¥</p>
<h2 id="å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”-1"><a href="#å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”-1" class="headerlink" title="å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”"></a>å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</h2><p>åœ¨ xchg çš„å‡è®¾ä¸‹ç®€åŒ–å®ç°</p>
<ul>
<li>åŒ…å«ä¸€ä¸ªåŸå­æŒ‡ä»¤</li>
<li>åŒ…å«ä¸€ä¸ª compiler barrier</li>
<li>åŒ…å«ä¸€ä¸ª memory fence<ul>
<li>sum-spinlock demo</li>
</ul>
</li>
</ul>
<pre class="highlight"><span class="line">int locked = 0;</span><br><span class="line"></span><br><span class="line">void lock() &#123;</span><br><span class="line">  while (xchg(&amp;locked, 1));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void unlock() &#123;</span><br><span class="line">  xchg(&amp;locked, 0);</span><br><span class="line">&#125;</span><br></pre>



<p>å›åˆ°ç´¯åŠ </p>
<pre class="highlight"><span class="line">#include &quot;thread.h&quot;</span><br><span class="line"></span><br><span class="line">#define N 100000000</span><br><span class="line">#define M 10</span><br><span class="line"></span><br><span class="line">long sum = 0;</span><br><span class="line"></span><br><span class="line">int xchg(int volatile *ptr, int newval) &#123;</span><br><span class="line">  int result;</span><br><span class="line">  asm volatile(</span><br><span class="line">    &quot;lock xchgl %0, %1&quot;</span><br><span class="line">    : &quot;+m&quot;(*ptr), &quot;=a&quot;(result)</span><br><span class="line">    : &quot;1&quot;(newval)</span><br><span class="line">    : &quot;memory&quot;</span><br><span class="line">  );</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int locked = 0;</span><br><span class="line"></span><br><span class="line">void lock() &#123;</span><br><span class="line">  while (xchg(&amp;locked, 1)) ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void unlock() &#123;</span><br><span class="line">  xchg(&amp;locked, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void Tsum() &#123;</span><br><span class="line">  long nround = N / M;</span><br><span class="line">  for (int i = 0; i &lt; nround; i++) &#123;</span><br><span class="line">    lock();</span><br><span class="line">    for (int j = 0; j &lt; M; j++) &#123;</span><br><span class="line">      sum++;  // Non-atomic; can optimize</span><br><span class="line">    &#125;</span><br><span class="line">    unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  assert(N % M == 0);</span><br><span class="line">  create(Tsum);</span><br><span class="line">  create(Tsum);</span><br><span class="line">  join();</span><br><span class="line">  printf(&quot;sum = %ld\n&quot;, sum);</span><br><span class="line">&#125;</span><br></pre>



<h2 id="æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤"><a href="#æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤" class="headerlink" title="æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤"></a>æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤</h2><p>Compare and exchange (â€œtest and setâ€)</p>
<ul>
<li>(lock) cmpxchg SRC, DEST</li>
</ul>
<pre class="highlight"><span class="line">TEMP = DEST</span><br><span class="line">if accumulator == TEMP:</span><br><span class="line">    ZF = 1</span><br><span class="line">    DEST = SRC</span><br><span class="line">else:</span><br><span class="line">    ZF = 0</span><br><span class="line">    accumulator = TEMP</span><br></pre>

<ul>
<li>ğŸ¤” çœ‹èµ·æ¥æ²¡å¤æ‚å¤šå°‘ï¼Œå¥½åƒåˆå¤æ‚äº†å¾ˆå¤š<ul>
<li>å­¦ç¼–ç¨‹&#x2F;æ“ä½œç³»ç»Ÿ â€œçº¸é¢ç†è§£â€ æ˜¯ä¸è¡Œçš„</li>
<li>ä¸€å®šè¦å†™ä»£ç åŠ æ·±å°è±¡<ul>
<li>å¯¹äºè¿™ä¸ªä¾‹å­ï¼šæˆ‘ä»¬å¯ä»¥åˆ—å‡º â€œçœŸå€¼è¡¨</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&#x2F;&#x2F;OSTEP Cçš„ä¼ªä»£ç </p>
<pre class="highlight"><span class="line"> <span class="type">int</span> <span class="title function_">CompareAndSwap</span><span class="params">(<span class="type">int</span> *ptr, <span class="type">int</span> expected, <span class="type">int</span> new)</span> &#123;</span><br><span class="line"> <span class="type">int</span> actual = *ptr;</span><br><span class="line"> <span class="keyword">if</span> (actual == expected)</span><br><span class="line"> *ptr = new;</span><br><span class="line"> <span class="keyword">return</span> actual;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">// *æ³¨æ„ï¼Œç§°ä¸ºä¼ªä»£ç çš„æ„æ€æ˜¯å®ƒå¹¶ä¸èƒ½å®ç°çœŸæ­£çš„ç¡¬ä»¶æ•ˆæœï¼Œå› ä¸ºæ¯ä¸€æ­¥åœ¨å®é™…æ‰§è¡Œæ—¶å¹¶éåŸå­æŒ‡ä»¤</span></span><br><span class="line"><span class="comment">// åœ¨çœŸæ­£ä½¿ç”¨cmpxchgæ—¶ï¼Œæ¯ä¸€æ­¥éƒ½æ˜¯åŸå­æŒ‡ä»¤ï¼Œå³ä½¿ç”¨lockå’Œmemoryä¿è¯compilerå’Œmemory barrier</span></span><br><span class="line"> </span><br></pre>

<pre class="highlight"><span class="line"> <span class="type">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">lock_t</span> *lock)</span> &#123;</span><br><span class="line"> <span class="keyword">while</span> (CompareAndSwap(&amp;lock-&gt;flag, <span class="number">0</span>, <span class="number">1</span>) == <span class="number">1</span>)</span><br><span class="line"> ; <span class="comment">// spin</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//lockå‡½æ•°</span></span><br></pre>

<p>æ¯”èµ·xchgï¼Œcmpxchgå°‘äº†ä¸€æ¬¡storeï¼Œå¤šäº†ä¸€æ¬¡åˆ¤æ–­</p>
<h2 id="å¤šå‡ºçš„-Compare-ç”¨å¤„"><a href="#å¤šå‡ºçš„-Compare-ç”¨å¤„" class="headerlink" title="å¤šå‡ºçš„ Compare: ç”¨å¤„"></a>å¤šå‡ºçš„ Compare: ç”¨å¤„</h2><p>åŒæ—¶æ£€æŸ¥ä¸Šä¸€æ¬¡è·å¾—çš„å€¼æ˜¯å¦ä»ç„¶æœ‰æ•ˆ + ä¿®æ”¹ç”Ÿæ•ˆ</p>
<pre class="highlight"><span class="line">// Create a new node</span><br><span class="line">retry:</span><br><span class="line">  expected = head;</span><br><span class="line">  node-&gt;next = expected;</span><br><span class="line">  seen = cmpxchg(expected, node, &amp;head);</span><br><span class="line">  if (seen != expected)</span><br><span class="line">    goto retry;</span><br></pre>





<h2 id="è‡ªæ—‹é”çš„ç¼ºé™·"><a href="#è‡ªæ—‹é”çš„ç¼ºé™·" class="headerlink" title="è‡ªæ—‹é”çš„ç¼ºé™·"></a>è‡ªæ—‹é”çš„ç¼ºé™·</h2><p>æ€§èƒ½é—®é¢˜ (1)</p>
<ul>
<li>é™¤äº†è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ï¼Œå…¶ä»–å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹éƒ½åœ¨ç©ºè½¬</li>
<li>äº‰æŠ¢é”çš„å¤„ç†å™¨è¶Šå¤šï¼Œåˆ©ç”¨ç‡è¶Šä½<ul>
<li>4 ä¸ª CPU è¿è¡Œ 4 ä¸ª sum-spinlock å’Œ 1 ä¸ª OBS<ul>
<li>ä»»æ„æ—¶åˆ»éƒ½åªæœ‰ä¸€ä¸ª sum-atomic åœ¨æœ‰æ•ˆè®¡ç®—</li>
</ul>
</li>
<li>å‡åˆ† CPU, OBS å°±åˆ†ä¸åˆ° 100% çš„ CPU äº†</li>
</ul>
</li>
</ul>
<hr>
<p>æ€§èƒ½é—®é¢˜ (2)</p>
<ul>
<li><p>æŒæœ‰è‡ªæ—‹é”çš„çº¿ç¨‹</p>
<p>å¯èƒ½è¢«æ“ä½œç³»ç»Ÿåˆ‡æ¢å‡ºå»</p>
<ul>
<li>æ“ä½œç³»ç»Ÿä¸ â€œæ„ŸçŸ¥â€ çº¿ç¨‹åœ¨åšä»€ä¹ˆ</li>
<li>(ä½†ä¸ºä»€ä¹ˆä¸èƒ½å‘¢ï¼Ÿ)</li>
</ul>
</li>
<li><p>å®ç° 100% çš„èµ„æºæµªè´¹</p>
</li>
</ul>
<h2 id="Scalability-æ€§èƒ½çš„æ–°ç»´åº¦"><a href="#Scalability-æ€§èƒ½çš„æ–°ç»´åº¦" class="headerlink" title="Scalability: æ€§èƒ½çš„æ–°ç»´åº¦"></a>Scalability: æ€§èƒ½çš„æ–°ç»´åº¦</h2><blockquote>
<p>åŒä¸€ä»½è®¡ç®—ä»»åŠ¡ï¼Œæ—¶é—´ (CPU cycles) å’Œç©ºé—´ (mapped memory) ä¼šéšå¤„ç†å™¨æ•°é‡çš„å¢é•¿è€Œå˜åŒ–ã€‚</p>
</blockquote>
<p>ç”¨è‡ªæ—‹é”å®ç° sum++ çš„æ€§èƒ½é—®é¢˜</p>
<ul>
<li>ä¸¥è°¨çš„ç»Ÿè®¡å¾ˆéš¾<ul>
<li>CPU åŠ¨æ€åŠŸè€—</li>
<li>ç³»ç»Ÿä¸­çš„å…¶ä»–è¿›ç¨‹</li>
<li>è¶…çº¿ç¨‹</li>
<li>NUMA</li>
<li>â€¦â€¦</li>
<li><a target="_blank" rel="noopener" href="https://www.cse.unsw.edu.au/~gernot/benchmarking-crimes.html">Benchmarking crimes</a></li>
</ul>
</li>
</ul>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230726225413.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230726225413.png"></p>
<p>sum-scalability</p>
<pre class="highlight"><span class="line">#include &quot;thread.h&quot;</span><br><span class="line">#include &quot;thread-sync.h&quot;</span><br><span class="line"></span><br><span class="line">#define N 10000000</span><br><span class="line">spinlock_t lock = SPIN_INIT();</span><br><span class="line"></span><br><span class="line">long n, sum = 0;</span><br><span class="line"></span><br><span class="line">void Tsum() &#123;</span><br><span class="line">  for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">    spin_lock(&amp;lock);</span><br><span class="line">    sum++;</span><br><span class="line">    spin_unlock(&amp;lock);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[]) &#123;</span><br><span class="line">  assert(argc == 2);</span><br><span class="line">  int nthread = atoi(argv[1]);</span><br><span class="line">  n = N / nthread;</span><br><span class="line">  for (int i = 0; i &lt; nthread; i++) &#123;</span><br><span class="line">    create(Tsum);</span><br><span class="line">  &#125;</span><br><span class="line">  join();</span><br><span class="line">  assert(sum == n * nthread);</span><br><span class="line">&#125;</span><br></pre>



<p>thread-sync.h</p>
<pre class="highlight"><span class="line">#include &lt;semaphore.h&gt;</span><br><span class="line"></span><br><span class="line">// Spinlock</span><br><span class="line">typedef int spinlock_t;</span><br><span class="line">#define SPIN_INIT() 0</span><br><span class="line"></span><br><span class="line">static inline int atomic_xchg(volatile int *addr, int newval) &#123;</span><br><span class="line">  int result;</span><br><span class="line">  asm volatile (&quot;lock xchg %0, %1&quot;:</span><br><span class="line">    &quot;+m&quot;(*addr), &quot;=a&quot;(result) : &quot;1&quot;(newval) : &quot;memory&quot;);</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void spin_lock(spinlock_t *lk) &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    intptr_t value = atomic_xchg(lk, 1);</span><br><span class="line">    if (value == 0) &#123;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">void spin_unlock(spinlock_t *lk) &#123;</span><br><span class="line">  atomic_xchg(lk, 0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Mutex</span><br><span class="line">typedef pthread_mutex_t mutex_t;</span><br><span class="line">#define MUTEX_INIT() PTHREAD_MUTEX_INITIALIZER</span><br><span class="line">void mutex_lock(mutex_t *lk)   &#123; pthread_mutex_lock(lk); &#125;</span><br><span class="line">void mutex_unlock(mutex_t *lk) &#123; pthread_mutex_unlock(lk); &#125;</span><br><span class="line"></span><br><span class="line">// Conditional Variable</span><br><span class="line">typedef pthread_cond_t cond_t;</span><br><span class="line">#define COND_INIT() PTHREAD_COND_INITIALIZER</span><br><span class="line">#define cond_wait pthread_cond_wait</span><br><span class="line">#define cond_broadcast pthread_cond_broadcast</span><br><span class="line">#define cond_signal pthread_cond_signal</span><br><span class="line"></span><br><span class="line">// Semaphore</span><br><span class="line">#define P sem_wait</span><br><span class="line">#define V sem_post</span><br><span class="line">#define SEM_INIT(sem, val) sem_init(sem, 0, val)</span><br></pre>

<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230726225641.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230726225641.png"></p>
<h2 id="è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯"><a href="#è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯"></a>è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯</h2><ol>
<li>ä¸´ç•ŒåŒºå‡ ä¹ä¸ â€œæ‹¥å µâ€</li>
<li>æŒæœ‰è‡ªæ—‹é”æ—¶ç¦æ­¢æ‰§è¡Œæµåˆ‡æ¢</li>
</ol>
<hr>
<p>ä½¿ç”¨åœºæ™¯ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„ (çŸ­ä¸´ç•ŒåŒº)</p>
<ul>
<li>æ“ä½œç³»ç»Ÿå¯ä»¥å…³é—­ä¸­æ–­å’ŒæŠ¢å <ul>
<li>ä¿è¯é”çš„æŒæœ‰è€…åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å¯ä»¥é‡Šæ”¾é”</li>
</ul>
</li>
<li>(å¦‚æœæ˜¯è™šæ‹Ÿæœºå‘¢â€¦ğŸ˜‚)<ul>
<li>PAUSE æŒ‡ä»¤ä¼šè§¦å‘ VM Exit</li>
</ul>
</li>
<li>ä½†ä¾æ—§å¾ˆéš¾åšå¥½<ul>
<li><a target="_blank" rel="noopener" href="https://www.usenix.org/conference/osdi10/analysis-linux-scalability-many-cores">An analysis of Linux scalability to many cores</a> (OSDIâ€™10)</li>
</ul>
</li>
</ul>
<h2 id="å®ç°çº¿ç¨‹-é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥"><a href="#å®ç°çº¿ç¨‹-é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥" class="headerlink" title="å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥"></a>å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥</h2><blockquote>
<p>ä½œä¸šé‚£ä¹ˆå¤šï¼Œä¸å…¶å¹²ç­‰ Online Judge å‘å¸ƒï¼Œä¸å¦‚æŠŠè‡ªå·± (CPU) è®©ç»™å…¶ä»–ä½œä¸š (çº¿ç¨‹) æ‰§è¡Œï¼Ÿ</p>
</blockquote>
<p>â€œè®©â€ ä¸æ˜¯ C è¯­è¨€ä»£ç å¯ä»¥åšåˆ°çš„ (C ä»£ç åªèƒ½æ‰§è¡ŒæŒ‡ä»¤)</p>
<ul>
<li><p>ä½†æœ‰ä¸€ç§ç‰¹æ®Šçš„æŒ‡ä»¤ï¼šsyscall</p>
</li>
<li><p>æŠŠé”çš„å®ç°æ”¾åˆ°æ“ä½œç³»ç»Ÿé‡Œå°±å¥½å•¦</p>
<ul>
<li>&#96;&#96;&#96;<br>syscall(SYSCALL_lock, &amp;lk);<pre class="highlight"><span class="line"></span><br><span class="line">  - è¯•å›¾è·å¾— `lk`ï¼Œä½†å¦‚æœå¤±è´¥ï¼Œå°±åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  syscall(SYSCALL_unlock, &amp;lk);</span><br></pre>

<ul>
<li>é‡Šæ”¾ <code>lk</code>ï¼Œå¦‚æœæœ‰ç­‰å¾…é”çš„çº¿ç¨‹å°±å”¤é†’</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å¾—ä¸åˆ°é”æ—¶ï¼Œä¸æµªè´¹CPU</p>
<h2 id="å®ç°çº¿ç¨‹-é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥-contâ€™d"><a href="#å®ç°çº¿ç¨‹-é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥-contâ€™d" class="headerlink" title="å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥ (contâ€™d)"></a>å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥ (contâ€™d)</h2><p>æ“ä½œç³»ç»Ÿ &#x3D; æ›´è¡£å®¤ç®¡ç†å‘˜</p>
<ul>
<li>å…ˆåˆ°çš„äºº (çº¿ç¨‹)<ul>
<li>æˆåŠŸè·å¾—æ‰‹ç¯ï¼Œè¿›å…¥æ¸¸æ³³é¦†</li>
<li><code>*lk = ğŸ”’</code>ï¼Œç³»ç»Ÿè°ƒç”¨ç›´æ¥è¿”å›</li>
</ul>
</li>
<li>ååˆ°çš„äºº (çº¿ç¨‹)<ul>
<li>ä¸èƒ½è¿›å…¥æ¸¸æ³³é¦†ï¼Œæ’é˜Ÿç­‰å¾…</li>
<li>çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæ‰§è¡Œçº¿ç¨‹åˆ‡æ¢ (yield)</li>
</ul>
</li>
<li>æ´—å®Œæ¾¡å‡ºæ¥çš„äºº (çº¿ç¨‹)<ul>
<li>äº¤è¿˜æ‰‹ç¯ç»™ç®¡ç†å‘˜ï¼›ç®¡ç†å‘˜æŠŠæ‰‹ç¯å†äº¤ç»™æ’é˜Ÿçš„äºº</li>
<li>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ</li>
<li>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œ<code>*lk = âœ…</code></li>
</ul>
</li>
<li>ç®¡ç†å‘˜ (OS) ä½¿ç”¨è‡ªæ—‹é”ç¡®ä¿è‡ªå·±å¤„ç†æ‰‹ç¯çš„è¿‡ç¨‹æ˜¯åŸå­çš„</li>
</ul>
<h2 id="å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ"><a href="#å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ" class="headerlink" title="å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ"></a>å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ</h2><p>è‡ªæ—‹é” (çº¿ç¨‹ç›´æ¥å…±äº« locked)</p>
<ul>
<li>æ›´å¿«çš„ fast path<ul>
<li>xchg æˆåŠŸ â†’ ç«‹å³è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¼€é”€å¾ˆå°</li>
</ul>
</li>
<li>æ›´æ…¢çš„ slow path<ul>
<li>xchg å¤±è´¥ â†’ æµªè´¹ CPU è‡ªæ—‹ç­‰å¾…</li>
</ul>
</li>
</ul>
<hr>
<p>äº’æ–¥é” (é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—® locked)</p>
<ul>
<li>æ›´ç»æµçš„ slow path<ul>
<li>ä¸Šé”å¤±è´¥çº¿ç¨‹ä¸å†å ç”¨ CPU</li>
</ul>
</li>
<li>æ›´æ…¢çš„ fast path<ul>
<li>å³ä¾¿ä¸Šé”æˆåŠŸä¹Ÿéœ€è¦è¿›å‡ºå†…æ ¸ (syscall)</li>
</ul>
</li>
</ul>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230726235931.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230726235931.png"></p>
<h2 id="å¼€å§‹è°ƒè¯•ä¹‹å‰"><a href="#å¼€å§‹è°ƒè¯•ä¹‹å‰" class="headerlink" title="å¼€å§‹è°ƒè¯•ä¹‹å‰"></a>å¼€å§‹è°ƒè¯•ä¹‹å‰</h2><p>æ‘†æ­£å¿ƒæ€ (ç¼–ç¨‹å“² â™‚ å­¦)</p>
<p>æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„</p>
<blockquote>
<p>ä¸ç®¡æ˜¯ crash äº†ï¼ŒWrong Answer äº†ï¼Œè¿˜æ˜¯è™šæ‹Ÿæœºç¥ç§˜é‡å¯ï¼Œéƒ½æ˜¯è‡ªå·±èƒŒé”…</p>
</blockquote>
<p>æœªæµ‹ä»£ç æ°¸è¿œæ˜¯é”™çš„</p>
<blockquote>
<p>ä½ ä»¥ä¸ºæœ€ä¸å¯èƒ½å‡º bug çš„åœ°æ–¹ï¼Œå¾€å¾€ bug å°±åœ¨é‚£èººç€</p>
</blockquote>
<p>â€œè½¯ä»¶â€ çš„ä¸¤å±‚å«ä¹‰</p>
<ul>
<li>äººç±»éœ€æ±‚åœ¨ä¿¡æ¯ä¸–ç•Œçš„æŠ•å½±<ul>
<li>ç†è§£é”™éœ€æ±‚ â†’ bug</li>
</ul>
</li>
<li>è®¡ç®—è¿‡ç¨‹çš„ç²¾ç¡® (æ•°å­¦) æè¿°<ul>
<li>å®ç°é”™è¯¯ â†’ bug</li>
</ul>
</li>
</ul>
<hr>
<p>è°ƒè¯• (debugging)</p>
<ul>
<li>å·²çŸ¥ç¨‹åºæœ‰ bugï¼Œå¦‚ä½•æ‰¾åˆ°ï¼Ÿ</li>
</ul>
<h2 id="è°ƒè¯•å›°éš¾çš„æ ¹æœ¬åŸå› "><a href="#è°ƒè¯•å›°éš¾çš„æ ¹æœ¬åŸå› " class="headerlink" title="è°ƒè¯•å›°éš¾çš„æ ¹æœ¬åŸå› "></a>è°ƒè¯•å›°éš¾çš„æ ¹æœ¬åŸå› </h2><p>å› ä¸º bug çš„è§¦å‘ç»å†äº†æ¼«é•¿çš„è¿‡ç¨‹</p>
<ul>
<li>éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  (çŠ¶æ€æœº) â†’ Fault (bug) â†’ Error (ç¨‹åºçŠ¶æ€é”™) â†’ Failure<ul>
<li>æˆ‘ä»¬åªèƒ½è§‚æµ‹åˆ° failure (å¯è§‚æµ‹çš„ç»“æœé”™)</li>
<li>æˆ‘ä»¬å¯ä»¥æ£€æŸ¥çŠ¶æ€çš„æ­£ç¡®æ€§ (ä½†éå¸¸è´¹æ—¶)</li>
<li>æ— æ³•é¢„çŸ¥ bug åœ¨å“ªé‡Œ (æ¯ä¸€è¡Œ â€œçœ‹èµ·æ¥â€ éƒ½æŒºå¯¹çš„)</li>
</ul>
</li>
</ul>
<h2 id="è°ƒè¯•ç†è®º"><a href="#è°ƒè¯•ç†è®º" class="headerlink" title="è°ƒè¯•ç†è®º"></a>è°ƒè¯•ç†è®º</h2><blockquote>
<p>è°ƒè¯•ç†è®ºï¼šå¦‚æœæˆ‘ä»¬èƒ½åˆ¤å®šä»»æ„ç¨‹åºçŠ¶æ€çš„æ­£ç¡®æ€§ï¼Œé‚£ä¹ˆç»™å®šä¸€ä¸ª failureï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒåˆ†æŸ¥æ‰¾å®šä½åˆ°ç¬¬ä¸€ä¸ª error çš„çŠ¶æ€ï¼Œæ­¤æ—¶çš„ä»£ç å°±æ˜¯ fault (bug)ã€‚</p>
</blockquote>
<hr>
<p>è°ƒè¯•ç†è®ºï¼šæ¨è®º</p>
<ul>
<li>ä¸ºä»€ä¹ˆæˆ‘ä»¬å–œæ¬¢ â€œå•æ­¥è°ƒè¯•â€ï¼Ÿ<ul>
<li>ä»ä¸€ä¸ªå‡å®šæ­£ç¡®çš„çŠ¶æ€å‡ºå‘</li>
<li>æ¯ä¸ªè¯­å¥çš„è¡Œä¸ºæœ‰é™ï¼Œå®¹æ˜“åˆ¤å®šæ˜¯å¦æ˜¯ error</li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆè°ƒè¯•ç†è®ºçœ‹èµ·æ¥å¾ˆæ²¡ç”¨ï¼Ÿ<ul>
<li>å› ä¸ºåˆ¤å®šç¨‹åºçŠ¶æ€çš„æ­£ç¡®æ€§éå¸¸å›°éš¾<ul>
<li>(æ˜¯å¦åœ¨è°ƒè¯• DP é¢˜&#x2F;å›¾è®ºç®—æ³•æ—¶é™·å…¥æ—¶é—´é»‘æ´ï¼Ÿ)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230728004530.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230728004530.png"></p>
<h2 id="è°ƒè¯•ç†è®º-contâ€™d"><a href="#è°ƒè¯•ç†è®º-contâ€™d" class="headerlink" title="è°ƒè¯•ç†è®º (contâ€™d)"></a>è°ƒè¯•ç†è®º (contâ€™d)</h2><p>å®é™…ä¸­çš„è°ƒè¯•ï¼šè§‚å¯ŸçŠ¶æ€æœºæ‰§è¡Œ (trace) çš„æŸä¸ªä¾§é¢</p>
<ul>
<li>ç¼©å°é”™è¯¯çŠ¶æ€ (error) å¯èƒ½äº§ç”Ÿçš„ä½ç½®</li>
<li>ä½œå‡ºé€‚å½“çš„å‡è®¾</li>
<li>å†è¿›è¡Œç»†ç²’åº¦çš„å®šä½å’Œè¯Šæ–­</li>
</ul>
<hr>
<p>æœ€é‡è¦çš„ä¸¤ä¸ªå·¥å…·</p>
<ul>
<li>printf â†’ è‡ªå®šä¹‰ log çš„ trace<ul>
<li>çµæ´»å¯æ§ã€èƒ½å¿«é€Ÿå®šä½é—®é¢˜å¤§æ¦‚ä½ç½®ã€é€‚ç”¨äºå¤§å‹è½¯ä»¶</li>
<li>æ— æ³•ç²¾ç¡®å®šä½ã€å¤§é‡çš„ logs ç®¡ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦</li>
</ul>
</li>
<li>gdb â†’ æŒ‡ä»¤&#x2F;è¯­å¥çº§ trace<ul>
<li>ç²¾ç¡®ã€æŒ‡ä»¤çº§å®šä½ã€ä»»æ„æŸ¥çœ‹ç¨‹åºå†…éƒ¨çŠ¶æ€</li>
<li>è€—è´¹å¤§é‡æ—¶é—´</li>
</ul>
</li>
</ul>
<h2 id="ä½ ä»¬æ˜¯å¦é‡åˆ°è¿‡ä»¥ä¸‹ä»¤äººæŠ“ç‹‚çš„æƒ…å†µï¼Ÿ"><a href="#ä½ ä»¬æ˜¯å¦é‡åˆ°è¿‡ä»¥ä¸‹ä»¤äººæŠ“ç‹‚çš„æƒ…å†µï¼Ÿ" class="headerlink" title="ä½ ä»¬æ˜¯å¦é‡åˆ°è¿‡ä»¥ä¸‹ä»¤äººæŠ“ç‹‚çš„æƒ…å†µï¼Ÿ"></a>ä½ ä»¬æ˜¯å¦é‡åˆ°è¿‡ä»¥ä¸‹ä»¤äººæŠ“ç‹‚çš„æƒ…å†µï¼Ÿ</h2><pre class="highlight"><span class="line">bash: curl: command not found</span><br></pre>

<hr>
<pre class="highlight"><span class="line">fatal error: &#x27;sys/cdefs.h&#x27;: No such file or directory</span><br><span class="line">#include &lt;sys/cdefs.h&gt;</span><br></pre>

<hr>
<pre class="highlight"><span class="line">make[2]: *** run: No such file or directory.  Stop.</span><br><span class="line">Makefile:31: recipe for target &#x27;run&#x27; failed</span><br><span class="line">make[1]: *** [run] Error 2</span><br><span class="line">...</span><br></pre>





<h2 id="è®¡ç®—æœºä¸–ç•Œï¼šä¸€åˆ‡çš†å¯è°ƒè¯•"><a href="#è®¡ç®—æœºä¸–ç•Œï¼šä¸€åˆ‡çš†å¯è°ƒè¯•" class="headerlink" title="è®¡ç®—æœºä¸–ç•Œï¼šä¸€åˆ‡çš†å¯è°ƒè¯•"></a>è®¡ç®—æœºä¸–ç•Œï¼šä¸€åˆ‡çš†å¯è°ƒè¯•</h2><p>ç¨‹åº &#x3D; è®¡ç®—æœºç³»ç»Ÿ &#x3D; çŠ¶æ€æœº</p>
<ul>
<li><p>æœºå™¨æ°¸è¿œæ˜¯å¯¹çš„</p>
</li>
<li><p>UNIX ä¸–ç•Œé‡Œä½ åšä»»ä½•äº‹æƒ…éƒ½æ˜¯åœ¨</p>
<p>ç¼–ç¨‹</p>
<ul>
<li>å› æ­¤é…ç½®é”™ã€make é”™ç­‰ï¼Œéƒ½æ˜¯ç¨‹åºæˆ–è¾“å…¥&#x2F;é…ç½®æœ‰ bug</li>
<li>(è¾“å…¥&#x2F;é…ç½®å¯ä»¥çœ‹æˆæ˜¯ç¨‹åºçš„ä¸€éƒ¨åˆ†)</li>
</ul>
</li>
</ul>
<hr>
<p>æ‰€æœ‰é—®é¢˜éƒ½å¯ä»¥ç”¨è°ƒè¯•ç†è®ºè§£å†³</p>
<ul>
<li>ä½ å†™äº†ä¸€ä¸ªç¨‹åºï¼Œç°åœ¨è¿™ä¸ªç¨‹åºå‡º bug äº† (ä¾‹å¦‚ Segmentation Fault)ï¼Œä½ æ˜¯æ€æ ·æ’æŸ¥è¿™ä¸ªé—®é¢˜çš„ï¼Ÿ<ul>
<li>curl: command not found</li>
<li><code>&#39;sys/cdefs.h&#39;</code>: No such file or directory</li>
<li>make: run: No such file or directory</li>
</ul>
</li>
</ul>
<h2 id="ä½¿ç”¨è°ƒè¯•ç†è®º"><a href="#ä½¿ç”¨è°ƒè¯•ç†è®º" class="headerlink" title="ä½¿ç”¨è°ƒè¯•ç†è®º"></a>ä½¿ç”¨è°ƒè¯•ç†è®º</h2><p>Debug (fault localization) çš„åŸºæœ¬ç†è®ºå›é¡¾ï¼š</p>
<ul>
<li>Fault (ç¨‹åº&#x2F;è¾“å…¥&#x2F;é…ç½®é”™) â†’ Error â†’ Failure (å¯è§‚æµ‹)<ul>
<li>ç»å¤§éƒ¨åˆ†å·¥å…·çš„ Failure éƒ½æœ‰ â€œåŸå› æŠ¥å‘Šâ€<ul>
<li>å› æ­¤èƒ½å¸®åŠ©ä½ å¿«é€Ÿå®šä½ fault</li>
</ul>
</li>
<li><code>man perror</code>ï¼šæ ‡å‡†åº“æœ‰æ‰“å° error message çš„å‡½æ•°</li>
</ul>
</li>
</ul>
<hr>
<p>å¦‚æœé—®é¢˜ä¸èƒ½å¸®ä½ å®šä½åˆ° fault&#x2F;errorï¼Ÿ</p>
<ul>
<li>å‡ºé”™åŸå› æŠ¥å‘Šä¸å‡†ç¡®æˆ–ä¸å¤Ÿè¯¦ç»†</li>
<li>ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹ä¸å¤Ÿè¯¦ç»†<ul>
<li>æ—¢ç„¶æˆ‘ä»¬æœ‰éœ€æ±‚ï¼Œé‚£åˆ«äººè‚¯å®šä¹Ÿä¼šæœ‰è¿™ä¸ªéœ€æ±‚<ul>
<li>ä¸€å®šæœ‰ä¿¡æ¯èƒ½å¸®åŠ©æˆ‘ä»¬ï¼</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>UNIXâ€“&gt; æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡º</p>
<h2 id="GDB-å…¥é—¨"><a href="#GDB-å…¥é—¨" class="headerlink" title="GDB: å…¥é—¨"></a>GDB: å…¥é—¨</h2><p>GDB: æœ€å¸¸ç”¨çš„å‘½ä»¤åœ¨ <a target="_blank" rel="noopener" href="https://jyywiki.cn/pages/OS/manuals/gdb-cheat-sheet.pdf">gdb cheat sheet</a></p>
<ul>
<li>æ‰“å°è´´åœ¨ç”µè„‘å‰ï¼Œè°ƒè¯•æ—¶å€™çœ‹ä¸€éï¼Œå¾ˆå¿«å°±å¤§è‡´è®°ä½äº†</li>
</ul>
<hr>
<p>æƒ³è¦æ›´å¥½çš„ä½“éªŒï¼Ÿ</p>
<ul>
<li>GDB æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªç¼–ç¨‹è¯­è¨€<ul>
<li>å®ƒç”šè‡³æ”¯æŒ Python</li>
<li>æˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€äº›åˆå§‹åŒ–ä»£ç  (-x)</li>
</ul>
</li>
<li>åº“å‡½æ•°ä¹Ÿæ˜¯ä»£ç <ul>
<li>directory å‘½ä»¤å¢åŠ æºç è·¯å¾„</li>
</ul>
</li>
<li>GDB æœ‰è®¸å¤šå‰ç«¯<ul>
<li>cgdb, pwndbg, vscode, â€¦</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/">RTFM</a> - M æ¯” ChatGPT å¥½ç”¨åœ¨äºå®ƒä¸éœ€è¦ prompt ä¸”å…¨é¢</li>
</ul>
<blockquote>
<p>printf æ˜¯æˆ‘ä»¬æœ€æ—©æ¥è§¦çš„åº“å‡½æ•°ä¹‹ä¸€ã€‚é‚£ä¹ˆåœ¨ glibc ä¸­çš„ printf ä»£ç åˆ°åº•åšäº†ä»€ä¹ˆå‘¢ï¼Ÿåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç° â€œproductionâ€ çš„ä»£ç ç»è¿‡å¤šå¹´çš„ç§¯ç´¯æ¼”åŒ–ï¼Œå·²ç»éå¸¸å¤æ‚ã€‚å› æ­¤æˆ‘ä»¬çš„å­¦ä¹ è·¯å¾„æ˜¯è®©å¤§å®¶å®ç°ç®€åŒ–çš„ç‰ˆæœ¬ (klib)ï¼Œå¹¶ä¸”é¼“åŠ±å¤§å®¶é˜…è¯»ä¸€äº›æ›´è½»é‡çº§çš„ libc ä»£ç  (ä¾‹å¦‚ <a target="_blank" rel="noopener" href="https://musl.libc.org/">musl</a>, newlib ç­‰)ã€‚å¾ˆå¤šå¼€æºæ“ä½œç³»ç»Ÿéƒ½é€‰æ‹©äº† musl ä½œä¸ºåº”ç”¨ç¨‹åºçš„æ”¯æ’‘å¹³å°ï¼šå®ƒåŠŸèƒ½å…¨é¢ã€ç²¾å·§ï¼Œä¸”<a target="_blank" rel="noopener" href="https://musl.libc.org/doc/1.1.24/manual.html">ç§»æ¤</a>å®ƒçš„å›°éš¾æ¯” glibc å°å¾—å¤š</p>
</blockquote>
<p>gcc -ggdb -Wall .c</p>
<p>gdb .o</p>
<p>layout src</p>
<p>record full</p>
<p>siï¼Œrsi</p>
<p>info thread</p>
<p>thread</p>
<h2 id="è°ƒè¯•ç†è®ºï¼šåº”ç”¨-Again"><a href="#è°ƒè¯•ç†è®ºï¼šåº”ç”¨-Again" class="headerlink" title="è°ƒè¯•ç†è®ºï¼šåº”ç”¨ (Again)"></a>è°ƒè¯•ç†è®ºï¼šåº”ç”¨ (Again)</h2><p>éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  â†’ Fault â†’ Error â†’ Failure</p>
<hr>
<p>â€œTechnical Debtâ€</p>
<blockquote>
<p>æ¯å½“ä½ å†™å‡ºä¸å¥½ç»´æŠ¤çš„ä»£ç ï¼Œä½ éƒ½åœ¨ç»™ä½ æœªæ¥çš„è°ƒè¯•&#x2F;éœ€æ±‚å˜æ›´æŒ–å‘ã€‚</p>
</blockquote>
<hr>
<p>ä¸­æªäº†ï¼Ÿ</p>
<ul>
<li>ä¸ºäº†å¿«ç‚¹è·‘ç¨‹åºï¼Œéšä¾¿å†™çš„ klib</li>
<li>ä¸ºäº†èµ¶ç´§å®ç°æŒ‡ä»¤ï¼Œéšæ‰‹å†™çš„ä»£ç </li>
<li>ä¸ºäº†åº”ä»˜è€æ¿ï¼Œéšä¾¿å†™çš„ç³»ç»Ÿå®ç°<ul>
<li>jyy çš„ code review: <del>æ—¥å¸¸è¡€å‹å‡é«˜æ—¶é—´</del></li>
</ul>
</li>
</ul>
<h2 id="ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾"><a href="#ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾" class="headerlink" title="ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾"></a>ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾</h2><blockquote>
<p>Programs are meant to be read by humans (AIs) and only incidentally for computers to execute. â€” <em>D. E. Knuth</em></p>
<p>(ç¨‹åºé¦–å…ˆæ˜¯æ‹¿ç»™äººè¯»çš„ï¼Œå…¶æ¬¡æ‰æ˜¯è¢«æœºå™¨æ‰§è¡Œã€‚)</p>
</blockquote>
<p>å¥½çš„ç¨‹åº</p>
<ul>
<li>ä¸è¨€è‡ªæ˜ï¼šèƒ½çŸ¥é“æ˜¯åšä»€ä¹ˆçš„ (specification)<ul>
<li>å› æ­¤ä»£ç é£æ ¼å¾ˆé‡è¦</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>ä¸è¨€è‡ªè¯ï¼šèƒ½ç¡®è®¤ä»£ç å’Œ specification ä¸€è‡´<ul>
<li>å› æ­¤ä»£ç ä¸­çš„é€»è¾‘æµå¾ˆé‡è¦</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>äººç±»æ–°çºªå…ƒçš„è¯„åˆ¤æ ‡å‡†<ul>
<li>AI æ˜¯å¦èƒ½æ­£ç¡®ç†è§£&#x2F;ç»´æŠ¤ä½ çš„ä»£ç </li>
</ul>
</li>
</ul>
<h2 id="è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨"><a href="#è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨" class="headerlink" title="è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨"></a>è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨</h2><blockquote>
<p>å†™å¥½è¯»ã€æ˜“éªŒè¯çš„ä»£ç </p>
<p>åœ¨ä»£ç ä¸­æ·»åŠ æ›´å¤šçš„æ–­è¨€ (assertions)</p>
</blockquote>
<hr>
<p>æ–­è¨€çš„æ„ä¹‰</p>
<ul>
<li>æŠŠä»£ç ä¸­éšè—çš„ specification å†™å‡ºæ¥<ul>
<li>Fault â†’ Error (é æµ‹è¯•)</li>
<li>Error â†’ Failure (é æ–­è¨€)<ul>
<li>Error æš´éœ²çš„è¶Šæ™šï¼Œè¶Šéš¾è°ƒè¯•</li>
<li>è¿½æº¯å¯¼è‡´ assert failure çš„å˜é‡å€¼ (slice) é€šå¸¸å¯ä»¥å¿«é€Ÿå®šä½åˆ° bug</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ä¾‹å­ï¼šç»´æŠ¤çˆ¶äº²èŠ‚ç‚¹çš„å¹³è¡¡æ ‘"><a href="#ä¾‹å­ï¼šç»´æŠ¤çˆ¶äº²èŠ‚ç‚¹çš„å¹³è¡¡æ ‘" class="headerlink" title="ä¾‹å­ï¼šç»´æŠ¤çˆ¶äº²èŠ‚ç‚¹çš„å¹³è¡¡æ ‘"></a>ä¾‹å­ï¼šç»´æŠ¤çˆ¶äº²èŠ‚ç‚¹çš„å¹³è¡¡æ ‘</h2><p><img src="http://web.cecs.pdx.edu/~sheard/course/Cs163/Graphics/rotation.png" alt="img" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="http://web.cecs.pdx.edu/~sheard/course/Cs163/Graphics/rotation.png" class="lozad post-image"></p>
<pre class="highlight"><span class="line">// ç»“æ„çº¦æŸ</span><br><span class="line">assert(u-&gt;parent == u ||</span><br><span class="line">       u-&gt;parent-&gt;left  == u ||</span><br><span class="line">       u-&gt;parent-&gt;right == u);</span><br><span class="line">assert(!u-&gt;left  || u-&gt;left-&gt;parent  == u);</span><br><span class="line">assert(!u-&gt;right || u-&gt;right-&gt;parent == u);</span><br><span class="line"></span><br><span class="line">// æ•°å€¼çº¦æŸ</span><br><span class="line">assert(!u-&gt;left  || u-&gt;left-&gt;val  &lt; u-&gt;val);</span><br><span class="line">assert(!u-&gt;right || u-&gt;right-&gt;val &gt; u-&gt;val);</span><br></pre>





<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230728005232.png" class="lozad post-image"src="https://picfloor-1310641479.cos-website.ap-shanghai.myqcloud.com/picfloor/20230728005232.png"></p>
<h2 id="ç¦åˆ©ï¼šæ›´å¤šçš„æ–­è¨€"><a href="#ç¦åˆ©ï¼šæ›´å¤šçš„æ–­è¨€" class="headerlink" title="ç¦åˆ©ï¼šæ›´å¤šçš„æ–­è¨€"></a>ç¦åˆ©ï¼šæ›´å¤šçš„æ–­è¨€</h2><p>ä½ æ˜¯å¦å¸Œæœ›åœ¨æ¯ä¸€æ¬¡æŒ‡é’ˆè®¿é—®æ—¶ï¼Œéƒ½å¢åŠ ä¸€ä¸ªæ–­è¨€</p>
<ul>
<li><code>assert(obj-&gt;low &lt;= ptr &amp;&amp; ptr &lt; obj-&gt;high);</code></li>
</ul>
<pre class="highlight"><span class="line">int *ref(int *a, int i) &#123;</span><br><span class="line">  return &amp;a[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void foo() &#123;</span><br><span class="line">  int arr[64];</span><br><span class="line">  *ref(arr, 64) = 1; // bug</span><br><span class="line">&#125;</span><br></pre>

<hr>
<p>ä¸€ä¸ªç¥å¥‡çš„ç¼–è¯‘é€‰é¡¹</p>
<ul>
<li>&#96;&#96;&#96;<br>-fsanitize&#x3D;address<pre class="highlight"><span class="line"></span><br><span class="line">  - Address Sanitizer; asan â€œåŠ¨æ€ç¨‹åºåˆ†æâ€</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## åŒæ­¥ (Synchronization)</span><br><span class="line"></span><br><span class="line">ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­ä¿æŒä¸€å®šçš„ç›¸å¯¹å…³ç³»</span><br><span class="line"></span><br><span class="line">- åŒæ­¥ç”µè·¯ (ä¸€ä¸ªæ—¶é’Ÿæ§åˆ¶æ‰€æœ‰è§¦å‘å™¨)</span><br><span class="line">- iPhone/iCloud åŒæ­¥ (æ‰‹æœº vs ç”µè„‘ vs äº‘ç«¯)</span><br><span class="line">- å˜é€Ÿç®±åŒæ­¥å™¨ (åˆå¹¶å¿«æ…¢é€Ÿé½¿è½®)</span><br><span class="line">- åŒæ­¥ç”µæœº (è½¬å­ä¸ç£åœºè½¬é€Ÿä¸€è‡´)</span><br><span class="line">- åŒæ­¥ç”µè·¯ (æ‰€æœ‰è§¦å‘å™¨åœ¨è¾¹æ²¿åŒæ—¶è§¦å‘)</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">å¼‚æ­¥ (Asynchronous) = ä¸éœ€è¦åŒæ­¥</span><br><span class="line"></span><br><span class="line">- ä¸Šè¿°å¾ˆå¤šä¾‹å­éƒ½æœ‰å¼‚æ­¥ç‰ˆæœ¬ (å¼‚æ­¥ç”µæœºã€å¼‚æ­¥ç”µè·¯ã€å¼‚æ­¥çº¿ç¨‹)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## å¹¶å‘ç¨‹åºä¸­çš„åŒæ­¥</span><br><span class="line"></span><br><span class="line">å¹¶å‘ç¨‹åºçš„æ­¥è°ƒå¾ˆéš¾ä¿æŒ â€œå®Œå…¨ä¸€è‡´â€</span><br><span class="line"></span><br><span class="line">- çº¿ç¨‹åŒæ­¥ï¼šåœ¨æŸä¸ªæ—¶é—´ç‚¹å…±åŒè¾¾åˆ°äº’ç›¸å·²çŸ¥çš„çŠ¶æ€</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å†æ¬¡æŠŠçº¿ç¨‹æƒ³è±¡æˆæˆ‘ä»¬è‡ªå·±</span><br><span class="line"></span><br><span class="line">- NPYï¼šç­‰æˆ‘æ´—ä¸ªå¤´å°±å‡ºé—¨/ç­‰æˆ‘æ‰“å®Œè¿™å±€æ¸¸æˆå°±æ¥</span><br><span class="line">- èˆå‹ï¼šç­‰æˆ‘ä¿®å¥½è¿™ä¸ª bug å°±åƒé¥­</span><br><span class="line">- å¯¼å¸ˆï¼šç­‰æˆ‘å‡ºå·®å›æ¥å°±è®¨è®ºè¿™ä¸ªè¯¾é¢˜</span><br><span class="line">- jyy:ç­‰æˆ‘æˆä¸ºå·ç‹å°±èººå¹³</span><br><span class="line">  - â€œå…ˆåˆ°å…ˆç­‰â€ï¼Œåœ¨æ¡ä»¶è¾¾æˆçš„ç¬é—´å†æ¬¡æ¢å¤å¹¶è¡Œ</span><br><span class="line">  - åŒæ—¶å¼€å§‹å‡ºå»ç©/åƒé¥­/è®¨è®º</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šå­¦åºŸä½ å°±èµ¢äº†</span><br><span class="line"></span><br><span class="line">&gt; 99% çš„å®é™…å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³ã€‚</span><br><span class="line"></span><br></pre>
void Tproduce() { while (1) printf(â€œ(â€œ); }<br>void Tconsume() { while (1) printf(â€œ)â€); }<pre class="highlight"><span class="line"></span><br><span class="line">åœ¨ `printf` å‰åå¢åŠ ä»£ç ï¼Œä½¿å¾—æ‰“å°çš„æ‹¬å·åºåˆ—æ»¡è¶³</span><br><span class="line"></span><br><span class="line">- ä¸€å®šæ˜¯æŸä¸ªåˆæ³•æ‹¬å·åºåˆ—çš„å‰ç¼€</span><br><span class="line">- æ‹¬å·åµŒå¥—çš„æ·±åº¦ä¸è¶…è¿‡*n*</span><br><span class="line">  - *n*=3, `((())())(((` åˆæ³•</span><br><span class="line">  - *n*=3, `(((())))`, `(()))` ä¸åˆæ³•</span><br><span class="line">- ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ä¸­çš„åŒæ­¥</span><br><span class="line">  - Tproduce: ç­‰åˆ°æœ‰ç©ºä½æ—¶æ‰èƒ½æ‰“å°å·¦æ‹¬å·</span><br><span class="line">  - Tconsume: ç­‰åˆ°æœ‰å¤šä½™çš„å·¦æ‹¬å·æ—¶æ‰èƒ½æ‰“å°å³æ‹¬å·</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## è®¡ç®—å›¾ã€è°ƒåº¦å™¨å’Œç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜</span><br><span class="line"></span><br><span class="line">ä¸ºä»€ä¹ˆå« â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€ è€Œä¸æ˜¯ â€œæ‹¬å·é—®é¢˜â€ï¼Ÿ</span><br><span class="line"></span><br><span class="line">- å·¦æ‹¬å·ï¼šç”Ÿäº§èµ„æº (ä»»åŠ¡)ã€æ”¾å…¥é˜Ÿåˆ—</span><br><span class="line">- å³æ‹¬å·ï¼šä»é˜Ÿåˆ—å–å‡ºèµ„æº (ä»»åŠ¡) æ‰§è¡Œ</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">å¹¶è¡Œè®¡ç®—åŸºç¡€ï¼šè®¡ç®—å›¾</span><br><span class="line"></span><br><span class="line">- è®¡ç®—ä»»åŠ¡æ„æˆæœ‰å‘æ— ç¯å›¾</span><br><span class="line">  - (*u*,*v*)âˆˆ*E* è¡¨ç¤º *v* è¦ç”¨åˆ°å‰ *u* çš„å€¼</span><br><span class="line">- åªè¦è°ƒåº¦å™¨ (ç”Ÿäº§è€…) åˆ†é…ä»»åŠ¡æ•ˆç‡å¤Ÿé«˜ï¼Œç®—æ³•å°±èƒ½å¹¶è¡Œ</span><br><span class="line">  - ç”Ÿäº§è€…æŠŠä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ä¸­</span><br><span class="line">  - æ¶ˆè´¹è€… (workers) ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼šå®ç°</span><br><span class="line"></span><br><span class="line">èƒ½å¦ç”¨äº’æ–¥é”å®ç°æ‹¬å·é—®é¢˜ï¼Ÿ</span><br><span class="line"></span><br><span class="line">- å·¦æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) ä¸è¶³ ï¿½*n* æ—¶æ‰èƒ½æ‰“å°</span><br><span class="line"></span><br><span class="line">- å³æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—)&gt;1æ—¶æ‰èƒ½æ‰“å°</span><br><span class="line"></span><br><span class="line">  - å½“ç„¶æ˜¯ç­‰åˆ°æ»¡è¶³æ¡ä»¶æ—¶å†æ‰“å°äº†</span><br><span class="line"></span><br><span class="line">    (ä»£ç æ¼”ç¤º)</span><br><span class="line"></span><br><span class="line">    - ç”¨äº’æ–¥é”ä¿æŒæ¡ä»¶æˆç«‹</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- å‹åŠ›æµ‹è¯• + è§‚å¯Ÿè¾“å‡ºç»“æœ</span><br><span class="line">- è‡ªåŠ¨è§‚å¯Ÿè¾“å‡ºç»“æœï¼š[pc-check.py](https://jyywiki.cn/pages/OS/2023/c/pc-check.py)</span><br><span class="line">- æœªæ¥ï¼šcopilot è§‚å¯Ÿè¾“å‡ºç»“æœï¼Œå¹¶ç»™å‡ºä¿®å¤å»ºè®®</span><br><span class="line">- æ›´è¿œçš„æœªæ¥ï¼š~~æˆ‘ä»¬éƒ½ä¸éœ€è¦ä¸å­˜åœ¨äº†~~</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## åŒæ­¥é—®é¢˜ï¼šåˆ†æ</span><br><span class="line"></span><br><span class="line">&gt; çº¿ç¨‹åŒæ­¥ç”±æ¡ä»¶ä¸æˆç«‹ç­‰å¾…å’ŒåŒæ­¥æ¡ä»¶è¾¾æˆç»§ç»­æ„æˆ</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹ join</span><br><span class="line"></span><br><span class="line">- Tmain åŒæ­¥æ¡ä»¶ï¼š`nexit == T`</span><br><span class="line">- Tmain è¾¾æˆåŒæ­¥ï¼šæœ€åä¸€ä¸ªçº¿ç¨‹é€€å‡º `nexit++`</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜</span><br><span class="line"></span><br><span class="line">- Tproduce åŒæ­¥æ¡ä»¶ï¼š`CAN_PRODUCE (count &lt; n)`</span><br><span class="line">- Tproduce è¾¾æˆåŒæ­¥ï¼šTconsume `count--`</span><br><span class="line">- Tconsume åŒæ­¥æ¡ä»¶ï¼š`CAN_CONSUME (count &gt; 0)`</span><br><span class="line">- Tconsume è¾¾æˆåŒæ­¥ï¼šTproduce `count++`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## ç†æƒ³ä¸­çš„åŒæ­¥ API</span><br><span class="line"></span><br></pre>
wait_until(CAN_PRODUCE) {<br>count++;<br>printf(â€œ(â€œ);<br>}</li>
</ul>
<p>wait_until(CAN_CONSUME) {<br>  countâ€“;<br>  printf(â€œ)â€);<br>}</p>
<pre class="highlight"><span class="line"></span><br><span class="line">è‹¥å¹²å®ç°ä¸Šçš„éš¾é¢˜</span><br><span class="line"></span><br><span class="line">- æ­£ç¡®æ€§</span><br><span class="line">  - å¤§æ‹¬å·å†…ä»£ç æ‰§è¡Œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸å¾—ç ´åç­‰å¾…çš„æ¡ä»¶</span><br><span class="line">- æ€§èƒ½</span><br><span class="line">  - ä¸èƒ½ spin check æ¡ä»¶è¾¾æˆ</span><br><span class="line">  - å·²ç»åœ¨ç­‰å¾…çš„çº¿ç¨‹æ€ä¹ˆçŸ¥é“æ¡ä»¶è¢«æ»¡è¶³ï¼Ÿ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## æ¡ä»¶å˜é‡ï¼šç†æƒ³ä¸å®ç°ä¹‹é—´çš„æŠ˜è¡·</span><br><span class="line"></span><br><span class="line">ä¸€æŠŠäº’æ–¥é” + ä¸€ä¸ª â€œæ¡ä»¶å˜é‡â€ + æ‰‹å·¥å”¤é†’</span><br><span class="line"></span><br><span class="line">- wait(cv, mutex) ğŸ’¤</span><br><span class="line">  - è°ƒç”¨æ—¶å¿…é¡»ä¿è¯å·²ç»è·å¾— mutex</span><br><span class="line">  - wait é‡Šæ”¾ mutexã€è¿›å…¥ç¡çœ çŠ¶æ€</span><br><span class="line">  - è¢«å”¤é†’åéœ€è¦é‡æ–°æ‰§è¡Œ lock(mutex)</span><br><span class="line">- signal/notify(cv) ğŸ’¬</span><br><span class="line">  - éšæœºç§ä¿¡ä¸€ä¸ªç­‰å¾…è€…ï¼šé†’é†’</span><br><span class="line">  - å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾… cvï¼Œåˆ™å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹</span><br><span class="line">- broadcast/notifyAll(cv) ğŸ“£</span><br><span class="line">  - å«é†’æ‰€æœ‰äºº</span><br><span class="line">  - å”¤é†’å…¨éƒ¨æ­£åœ¨ç­‰å¾… cv çš„çº¿ç¨‹</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## æ¡ä»¶å˜é‡ï¼šå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…</span><br><span class="line"></span><br></pre>
<p>void Tproduce() {<br>  mutex_lock(&amp;lk);<br>  if (!CAN_PRODUCE) cond_wait(&amp;cv, &amp;lk);<br>  printf(â€œ(â€œ); count++; cond_signal(&amp;cv);<br>  mutex_unlock(&amp;lk);<br>}</p>
<p>void Tconsume() {<br>  mutex_lock(&amp;lk);<br>  if (!CAN_CONSUME) cond_wait(&amp;cv, &amp;lk);<br>  printf(â€œ)â€); countâ€“; cond_signal(&amp;cv);<br>  mutex_unlock(&amp;lk);<br>}</p>
<pre class="highlight"><span class="line"></span><br><span class="line">ä»£ç æ¼”ç¤º &amp; å‹åŠ›æµ‹è¯• &amp; æ¨¡å‹æ£€éªŒ</span><br><span class="line"></span><br><span class="line">- (Small scope hypothesis)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">producerå’Œconsumerä¸€å¤šï¼Œæµ‹è¯•å°±ä¸é€šè¿‡ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</span><br><span class="line"></span><br><span class="line">å”¤é†’çš„æ—¶å€™æ²¡æœ‰é‡æ–°æ£€æŸ¥æ¡ä»¶å˜é‡ï¼Œè€Œæ˜¯ç›´æ¥æ‰“å°æ‹¬å·</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ­£ç¡®æ ·ä¾‹</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```C</span><br><span class="line">#include &quot;thread.h&quot;</span><br><span class="line">#include &quot;thread-sync.h&quot;</span><br><span class="line"></span><br><span class="line">int n, count = 0;</span><br><span class="line">mutex_t lk = MUTEX_INIT();</span><br><span class="line">cond_t cv = COND_INIT();</span><br><span class="line"> </span><br><span class="line">#define CAN_PRODUCE (count &lt; n)</span><br><span class="line">#define CAN_CONSUME (count &gt; 0)</span><br><span class="line"></span><br><span class="line">void Tproduce() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    mutex_lock(&amp;lk);</span><br><span class="line">    while (!CAN_PRODUCE) &#123;</span><br><span class="line">      cond_wait(&amp;cv, &amp;lk);</span><br><span class="line">    &#125;</span><br><span class="line">    printf(&quot;(&quot;); count++;</span><br><span class="line">    cond_broadcast(&amp;cv);</span><br><span class="line">    mutex_unlock(&amp;lk);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void Tconsume() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    mutex_lock(&amp;lk);</span><br><span class="line">    while (!CAN_CONSUME) &#123;</span><br><span class="line">      cond_wait(&amp;cv, &amp;lk);</span><br><span class="line">    &#125;</span><br><span class="line">    printf(&quot;)&quot;); count--;</span><br><span class="line">    cond_broadcast(&amp;cv);</span><br><span class="line">    mutex_unlock(&amp;lk);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[]) &#123;</span><br><span class="line">  assert(argc == 3);</span><br><span class="line">  n = atoi(argv[1]);</span><br><span class="line">  int T = atoi(argv[2]);</span><br><span class="line">  setbuf(stdout, NULL);</span><br><span class="line">  for (int i = 0; i &lt; T; i++) &#123;</span><br><span class="line">    create(Tproduce);</span><br><span class="line">    create(Tconsume);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>



<blockquote>
<p>ç¼–å†™æ­£ç¡®çš„å¹¶å‘ç¨‹åºå¹¶éæ˜“äº‹ï¼Œå³ä¾¿æ˜¯èµ„æ·±çš„ç³»ç»Ÿç¨‹åºå‘˜ (åŒ…æ‹¬ Linux å†…æ ¸å¼€å‘è€…) éƒ½æ— æ³•é¿å…åœ¨ä»£ç ä¸­å¼•å…¥å¹¶å‘ bugã€‚å‹åŠ›æµ‹è¯•ã€æ¨¡å‹æ£€éªŒéƒ½æ˜¯å¸®åŠ©æˆ‘ä»¬æå‡å¯¹å¹¶å‘ç¨‹åºæ­£ç¡®æ€§ä¿¡å¿ƒçš„æ‰‹æ®µã€‚é™¤æ­¤ä¹‹å¤–ï¼Œé˜²å¾¡æ€§åœ°ç¼–ç¨‹ (ä¾‹å¦‚å†™å‡ºå°½å¯èƒ½ç®€å•ã€æ­£ç¡®æ€§æ˜äº†çš„ä»£ç ) ä¹Ÿæ˜¯è‡³å…³é‡è¦çš„ã€‚</p>
</blockquote>
<h2 id="æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶-M2"><a href="#æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶-M2" class="headerlink" title="æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶ (M2)"></a>æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶ (M2)</h2><pre class="highlight"><span class="line">struct work &#123;</span><br><span class="line">  void (*run)(void *arg);</span><br><span class="line">  void *arg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void Tworker() &#123;</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    struct work *work;</span><br><span class="line">    wait_until(has_new_work() || all_done) &#123;</span><br><span class="line">      work = get_work();</span><br><span class="line">    &#125;</span><br><span class="line">    if (!work) break;</span><br><span class="line">    else &#123;</span><br><span class="line">      work-&gt;run(work-&gt;arg); // å…è®¸ç”Ÿæˆæ–°çš„ work (æ³¨æ„äº’æ–¥)</span><br><span class="line">      release(work);  // æ³¨æ„å›æ”¶ work åˆ†é…çš„èµ„æº</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>





<h2 id="æ¡ä»¶å˜é‡ï¼šæ›´å¤æ€ªçš„ä¹ é¢˜-x2F-é¢è¯•é¢˜"><a href="#æ¡ä»¶å˜é‡ï¼šæ›´å¤æ€ªçš„ä¹ é¢˜-x2F-é¢è¯•é¢˜" class="headerlink" title="æ¡ä»¶å˜é‡ï¼šæ›´å¤æ€ªçš„ä¹ é¢˜&#x2F;é¢è¯•é¢˜"></a>æ¡ä»¶å˜é‡ï¼šæ›´å¤æ€ªçš„ä¹ é¢˜&#x2F;é¢è¯•é¢˜</h2><p>æœ‰ä¸‰ç§çº¿ç¨‹</p>
<ul>
<li>Ta è‹¥å¹²: æ­»å¾ªç¯æ‰“å° <code>&lt;</code></li>
<li>Tb è‹¥å¹²: æ­»å¾ªç¯æ‰“å° <code>&gt;</code></li>
<li>Tc è‹¥å¹²: æ­»å¾ªç¯æ‰“å° <code>_</code></li>
</ul>
<p>ä»»åŠ¡ï¼š</p>
<ul>
<li>å¯¹è¿™äº›çº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œä½¿å¾—å±å¹•æ‰“å°å‡º <code>&lt;&gt;&lt;_</code> å’Œ <code>&gt;&lt;&gt;_</code> çš„ç»„åˆ</li>
</ul>
<hr>
<p>ä½¿ç”¨æ¡ä»¶å˜é‡ï¼Œåªè¦å›ç­”ä¸‰ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>æ‰“å° â€œ<code>&lt;</code>â€ çš„æ¡ä»¶ï¼Ÿ</li>
<li>æ‰“å° â€œ<code>&gt;</code>â€ çš„æ¡ä»¶ï¼Ÿ</li>
<li>æ‰“å° â€œ<code>_</code>â€ çš„æ¡ä»¶ï¼Ÿ</li>
</ul>
<p>æºç </p>
<pre class="highlight"><span class="line">#include &quot;thread.h&quot;</span><br><span class="line">#include &quot;thread-sync.h&quot;</span><br><span class="line"></span><br><span class="line">#define LENGTH(arr) (sizeof(arr) / sizeof(arr[0]))</span><br><span class="line"></span><br><span class="line">enum &#123; A = 1, B, C, D, E, F, &#125;;</span><br><span class="line"></span><br><span class="line">struct rule &#123;</span><br><span class="line">  int from, ch, to;</span><br><span class="line">&#125; rules[] = &#123;</span><br><span class="line">  &#123; A, &#x27;&lt;&#x27;, B &#125;,</span><br><span class="line">  &#123; B, &#x27;&gt;&#x27;, C &#125;,</span><br><span class="line">  &#123; C, &#x27;&lt;&#x27;, D &#125;,</span><br><span class="line">  &#123; A, &#x27;&gt;&#x27;, E &#125;,</span><br><span class="line">  &#123; E, &#x27;&lt;&#x27;, F &#125;,</span><br><span class="line">  &#123; F, &#x27;&gt;&#x27;, D &#125;,</span><br><span class="line">  &#123; D, &#x27;_&#x27;, A &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">int current = A, quota = 1;</span><br><span class="line"></span><br><span class="line">mutex_t lk = MUTEX_INIT();</span><br><span class="line">cond_t cv = COND_INIT();</span><br><span class="line"></span><br><span class="line">int next(char ch) &#123;</span><br><span class="line">  for (int i = 0; i &lt; LENGTH(rules); i++) &#123;</span><br><span class="line">    struct rule *rule = &amp;rules[i];</span><br><span class="line">    if (rule-&gt;from == current &amp;&amp; rule-&gt;ch == ch) &#123;</span><br><span class="line">      return rule-&gt;to;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int can_print(char ch) &#123;</span><br><span class="line">    return next(ch) != 0 &amp;&amp; quota &gt; 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void fish_before(char ch) &#123;</span><br><span class="line">  mutex_lock(&amp;lk);</span><br><span class="line">  while (!can_print(ch)) &#123;</span><br><span class="line">    // can proceed only if (next(ch) &amp;&amp; quota)</span><br><span class="line">    cond_wait(&amp;cv, &amp;lk);</span><br><span class="line">  &#125;</span><br><span class="line">  quota--;</span><br><span class="line">  mutex_unlock(&amp;lk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void fish_after(char ch) &#123;</span><br><span class="line">  mutex_lock(&amp;lk);</span><br><span class="line">  quota++;</span><br><span class="line">  current = next(ch);</span><br><span class="line">  assert(current);</span><br><span class="line">  cond_broadcast(&amp;cv);</span><br><span class="line">  mutex_unlock(&amp;lk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const char roles[] = &quot;.&lt;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;___&quot;;</span><br><span class="line"></span><br><span class="line">void fish_thread(int id) &#123;</span><br><span class="line">  char role = roles[id];</span><br><span class="line">  while (1) &#123;</span><br><span class="line">    fish_before(role);</span><br><span class="line">    putchar(role);  // Not lock-protected</span><br><span class="line">    fish_after(role);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  setbuf(stdout, NULL);</span><br><span class="line">  for (int i = 0; i &lt; strlen(roles); i++)</span><br><span class="line">    create(fish_thread);</span><br><span class="line">&#125;</span><br></pre>



<p>åŒæ­¥çš„æœ¬è´¨æ˜¯çº¿ç¨‹éœ€è¦ç­‰å¾…æŸä»¶å®ƒæ‰€é¢„æœŸçš„äº‹ä»¶å‘ç”Ÿï¼Œè€Œäº‹ä»¶çš„å‘ç”Ÿæ€»æ˜¯å¯ä»¥ç”¨å…±äº«çŠ¶æ€çš„æ¡ä»¶æ¥è¡¨è¾¾ã€‚å¹¶ä¸”åœ¨è¿™ä¸ªæ¡ä»¶è¢«æ»¡è¶³çš„å‰æä¸‹å®Œæˆä¸€äº›åŠ¨ä½œï¼š</p>
<pre class="highlight"><span class="line">WAIT_UNTIL(cond) with (mutex) &#123;</span><br><span class="line">  // cond åœ¨æ­¤æ—¶æˆç«‹</span><br><span class="line">  work();</span><br><span class="line">&#125;</span><br></pre>

<p>è®¡ç®—æœºç³»ç»Ÿçš„è®¾è®¡è€…æä¾›äº†æ¡ä»¶å˜é‡çš„æœºåˆ¶æ¨¡ä»¿è¿™ä¸ªè¿‡ç¨‹ï¼Œå®ƒä¸äº’æ–¥é”è”åˆä½¿ç”¨ï¼š</p>
<ul>
<li><code>cond_wait(cv, lk)</code> é‡Šæ”¾äº’æ–¥é” <code>lk</code> å¹¶è¿›å…¥ç¡çœ çŠ¶æ€ã€‚æ³¨æ„è¢«å”¤é†’æ—¶ï¼Œ<code>cond_wait</code> ä¼šé‡æ–°è¯•å›¾è·å¾—äº’æ–¥ï¼Œç›´åˆ°è·å¾—äº’æ–¥é”åæ‰èƒ½è¿”å›ã€‚</li>
<li><code>cond_signal(cv)</code> å”¤é†’ä¸€ä¸ªåœ¨ <code>cv</code> ä¸Šç­‰å¾…çš„çº¿ç¨‹</li>
<li><code>cond_broadcast(cv)</code> å”¤é†’æ‰€æœ‰åœ¨ <code>cv</code> ä¸Šç­‰å¾…çš„çº¿ç¨‹</li>
</ul>
<p>æˆ‘ä»¬ä¹Ÿå¾ˆè‡ªç„¶åœ°å¯ä»¥ç”¨ wait + broadcast å®ç° <code>WAIT_UNTIL</code>ï¼Œä»è€Œå®ç°çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ã€‚</p>

  </div>
  <div>
    
      <div 
        class="post-note note-warning copyright" 
        style="margin-top: 42px">
        <p>
          <span style="font-weight: bold;">ä½œè€…ï¼š</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="/about">
            JKLASDWD
          </a>
        </p>
        <p>
          <span style="font-weight: bold;">æ–‡ç« é“¾æ¥ï¼š</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="https://github.com/JKLASDWD/JKLASDWD.github.io/2023/07/29/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
            https://github.com/JKLASDWD/JKLASDWD.github.io/2023/07/29/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/
          </a>
        </p>
        <p><span style="font-weight: bold;">ç‰ˆæƒå£°æ˜ï¼š</span>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 åè®®</a>ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
      </div>
    
  </div>
</article>
<div class="nav">
  
  
    <div class="nav-item-next">
      <a 
        href="/2023/05/24/Ubuntu%E5%90%8C%E6%AD%A5%E6%96%87%E4%BB%B6%E5%88%B0Onedrive/" 
        class="nav-link">
        <div>
          <div class="nav-label">Next</div>
          
            <div class="nav-title">UbuntuåŒæ­¥æ–‡ä»¶åˆ°Onedrive </div>
          
        </div>
        <i class="iconfont icon-right nav-next-icon"></i>
      </a>
    </div>
  
</div>

<div 
  class="card card-content toc-card" 
  id="mobiletoc">
  <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-text">å†™åœ¨å‰é¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E7%9A%84%E7%8A%B6%E6%80%81%E6%9C%BA%E6%A8%A1%E5%9E%8B"><span class="toc-text">æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95-C-%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%8A%B6%E6%80%81%E6%9C%BA%E6%A8%A1%E5%9E%8B-%E8%AF%AD%E4%B9%89"><span class="toc-text">ç®€å• C ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ (è¯­ä¹‰)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Python%E4%B8%AD%E6%A8%A1%E6%8B%9F%E5%A4%9A%E7%BA%BF%E7%A8%8B%E3%80%81%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%93%8D%E4%BD%9C"><span class="toc-text">åœ¨Pythonä¸­æ¨¡æ‹Ÿå¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83"><span class="toc-text">5. å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E5%87%BA%E6%9B%B4%E5%A4%9A%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">é—®å‡ºæ›´å¤šçš„é—®é¢˜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E6%9C%BA%E7%9A%84%E9%9A%90%E5%90%AB%E5%81%87%E8%AE%BE"><span class="toc-text">çŠ¶æ€æœºçš„éšå«å‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%B1%82%E5%92%8C"><span class="toc-text">ä¾‹å­ï¼šæ±‚å’Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83-1-%EF%BC%9A%E6%8C%87%E4%BB%A4-x2F-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%8E%9F%E5%AD%90%E6%80%A7%E5%81%87%E8%AE%BE"><span class="toc-text">æ”¾å¼ƒ (1)ï¼šæŒ‡ä»¤&#x2F;ä»£ç æ‰§è¡ŒåŸå­æ€§å‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83%E5%8E%9F%E5%AD%90%E6%80%A7%E5%81%87%E8%AE%BE%E7%9A%84%E5%90%8E%E6%9E%9C"><span class="toc-text">æ”¾å¼ƒåŸå­æ€§å‡è®¾çš„åæœ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%B1%82%E5%92%8C-%E5%86%8D%E6%AC%A1%E5%87%BA%E7%8E%B0"><span class="toc-text">ä¾‹å­ï¼šæ±‚å’Œ (å†æ¬¡å‡ºç°)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83-2-%EF%BC%9A%E7%A8%8B%E5%BA%8F%E7%9A%84%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C%E5%81%87%E8%AE%BE"><span class="toc-text">æ”¾å¼ƒ (2)ï¼šç¨‹åºçš„é¡ºåºæ‰§è¡Œå‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E8%AF%81%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-text">ä¿è¯æ‰§è¡Œé¡ºåº</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E6%B1%82%E5%92%8C"><span class="toc-text">å®ç°æ­£ç¡®çš„æ±‚å’Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98%EF%BC%9A%E5%AE%9A%E4%B9%89"><span class="toc-text">äº’æ–¥é—®é¢˜ï¼šå®šä¹‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98%E7%9A%84%E7%BB%8F%E5%85%B8%E7%AE%97%E6%B3%95"><span class="toc-text">äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%81%87%E8%AE%BE"><span class="toc-text">å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Atomic-Exchange-%E5%AE%9E%E7%8E%B0"><span class="toc-text">Atomic Exchange å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%EF%BC%9A%E5%81%9A%E9%A2%98%E5%AE%B6-v-s-%E7%A7%91%E5%AD%A6%E5%AE%B6"><span class="toc-text">å®ç°äº’æ–¥ï¼šåšé¢˜å®¶ v.s. ç§‘å­¦å®¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%EF%BC%9A%E8%87%AA%E6%97%8B%E9%94%81"><span class="toc-text">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%EF%BC%9A%E8%87%AA%E6%97%8B%E9%94%81-1"><span class="toc-text">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E5%BC%BA%E5%A4%A7%E7%9A%84%E5%8E%9F%E5%AD%90%E6%8C%87%E4%BB%A4"><span class="toc-text">æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%87%BA%E7%9A%84-Compare-%E7%94%A8%E5%A4%84"><span class="toc-text">å¤šå‡ºçš„ Compare: ç”¨å¤„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="toc-text">è‡ªæ—‹é”çš„ç¼ºé™·</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scalability-%E6%80%A7%E8%83%BD%E7%9A%84%E6%96%B0%E7%BB%B4%E5%BA%A6"><span class="toc-text">Scalability: æ€§èƒ½çš„æ–°ç»´åº¦</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B-%E9%95%BF%E4%B8%B4%E7%95%8C%E5%8C%BA%E7%9A%84%E4%BA%92%E6%96%A5"><span class="toc-text">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B-%E9%95%BF%E4%B8%B4%E7%95%8C%E5%8C%BA%E7%9A%84%E4%BA%92%E6%96%A5-cont%E2%80%99d"><span class="toc-text">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥ (contâ€™d)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E4%BA%92%E6%96%A5%E7%9A%84%E4%B8%80%E4%BA%9B%E5%88%86%E6%9E%90"><span class="toc-text">å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E8%B0%83%E8%AF%95%E4%B9%8B%E5%89%8D"><span class="toc-text">å¼€å§‹è°ƒè¯•ä¹‹å‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%9B%B0%E9%9A%BE%E7%9A%84%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0"><span class="toc-text">è°ƒè¯•å›°éš¾çš„æ ¹æœ¬åŸå› </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA"><span class="toc-text">è°ƒè¯•ç†è®º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA-cont%E2%80%99d"><span class="toc-text">è°ƒè¯•ç†è®º (contâ€™d)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%A0%E4%BB%AC%E6%98%AF%E5%90%A6%E9%81%87%E5%88%B0%E8%BF%87%E4%BB%A5%E4%B8%8B%E4%BB%A4%E4%BA%BA%E6%8A%93%E7%8B%82%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%9F"><span class="toc-text">ä½ ä»¬æ˜¯å¦é‡åˆ°è¿‡ä»¥ä¸‹ä»¤äººæŠ“ç‹‚çš„æƒ…å†µï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%96%E7%95%8C%EF%BC%9A%E4%B8%80%E5%88%87%E7%9A%86%E5%8F%AF%E8%B0%83%E8%AF%95"><span class="toc-text">è®¡ç®—æœºä¸–ç•Œï¼šä¸€åˆ‡çš†å¯è°ƒè¯•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA"><span class="toc-text">ä½¿ç”¨è°ƒè¯•ç†è®º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GDB-%E5%85%A5%E9%97%A8"><span class="toc-text">GDB: å…¥é—¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA%EF%BC%9A%E5%BA%94%E7%94%A8-Again"><span class="toc-text">è°ƒè¯•ç†è®ºï¼šåº”ç”¨ (Again)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A8%8B%E5%9F%BA%E6%9C%AC%E5%87%86%E5%88%99%EF%BC%9A%E5%9B%9E%E9%A1%BE"><span class="toc-text">ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA%E7%9A%84%E6%9C%80%E9%87%8D%E8%A6%81%E5%BA%94%E7%94%A8"><span class="toc-text">è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E7%BB%B4%E6%8A%A4%E7%88%B6%E4%BA%B2%E8%8A%82%E7%82%B9%E7%9A%84%E5%B9%B3%E8%A1%A1%E6%A0%91"><span class="toc-text">ä¾‹å­ï¼šç»´æŠ¤çˆ¶äº²èŠ‚ç‚¹çš„å¹³è¡¡æ ‘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A6%8F%E5%88%A9%EF%BC%9A%E6%9B%B4%E5%A4%9A%E7%9A%84%E6%96%AD%E8%A8%80"><span class="toc-text">ç¦åˆ©ï¼šæ›´å¤šçš„æ–­è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%EF%BC%9A%E4%B8%87%E8%83%BD%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6-M2"><span class="toc-text">æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶ (M2)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%EF%BC%9A%E6%9B%B4%E5%8F%A4%E6%80%AA%E7%9A%84%E4%B9%A0%E9%A2%98-x2F-%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-text">æ¡ä»¶å˜é‡ï¼šæ›´å¤æ€ªçš„ä¹ é¢˜&#x2F;é¢è¯•é¢˜</span></a>
</div>
            </main>
            <aside class="right-column">
              <div class="sticky-widescreen">
  
  
    <article class="card card-content toc-card">
      <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-text">å†™åœ¨å‰é¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E7%9A%84%E7%8A%B6%E6%80%81%E6%9C%BA%E6%A8%A1%E5%9E%8B"><span class="toc-text">æ±‡ç¼–ä»£ç çš„çŠ¶æ€æœºæ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95-C-%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%8A%B6%E6%80%81%E6%9C%BA%E6%A8%A1%E5%9E%8B-%E8%AF%AD%E4%B9%89"><span class="toc-text">ç®€å• C ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ (è¯­ä¹‰)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8Python%E4%B8%AD%E6%A8%A1%E6%8B%9F%E5%A4%9A%E7%BA%BF%E7%A8%8B%E3%80%81%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%93%8D%E4%BD%9C"><span class="toc-text">åœ¨Pythonä¸­æ¨¡æ‹Ÿå¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83"><span class="toc-text">5. å¤šå¤„ç†å™¨ç¼–ç¨‹ï¼šä»å…¥é—¨åˆ°æ”¾å¼ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E5%87%BA%E6%9B%B4%E5%A4%9A%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">é—®å‡ºæ›´å¤šçš„é—®é¢˜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E6%9C%BA%E7%9A%84%E9%9A%90%E5%90%AB%E5%81%87%E8%AE%BE"><span class="toc-text">çŠ¶æ€æœºçš„éšå«å‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%B1%82%E5%92%8C"><span class="toc-text">ä¾‹å­ï¼šæ±‚å’Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83-1-%EF%BC%9A%E6%8C%87%E4%BB%A4-x2F-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%8E%9F%E5%AD%90%E6%80%A7%E5%81%87%E8%AE%BE"><span class="toc-text">æ”¾å¼ƒ (1)ï¼šæŒ‡ä»¤&#x2F;ä»£ç æ‰§è¡ŒåŸå­æ€§å‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83%E5%8E%9F%E5%AD%90%E6%80%A7%E5%81%87%E8%AE%BE%E7%9A%84%E5%90%8E%E6%9E%9C"><span class="toc-text">æ”¾å¼ƒåŸå­æ€§å‡è®¾çš„åæœ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E6%B1%82%E5%92%8C-%E5%86%8D%E6%AC%A1%E5%87%BA%E7%8E%B0"><span class="toc-text">ä¾‹å­ï¼šæ±‚å’Œ (å†æ¬¡å‡ºç°)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83-2-%EF%BC%9A%E7%A8%8B%E5%BA%8F%E7%9A%84%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C%E5%81%87%E8%AE%BE"><span class="toc-text">æ”¾å¼ƒ (2)ï¼šç¨‹åºçš„é¡ºåºæ‰§è¡Œå‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E8%AF%81%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-text">ä¿è¯æ‰§è¡Œé¡ºåº</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A3%E7%A1%AE%E7%9A%84%E6%B1%82%E5%92%8C"><span class="toc-text">å®ç°æ­£ç¡®çš„æ±‚å’Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98%EF%BC%9A%E5%AE%9A%E4%B9%89"><span class="toc-text">äº’æ–¥é—®é¢˜ï¼šå®šä¹‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98%E7%9A%84%E7%BB%8F%E5%85%B8%E7%AE%97%E6%B3%95"><span class="toc-text">äº’æ–¥é—®é¢˜çš„ç»å…¸ç®—æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%81%87%E8%AE%BE"><span class="toc-text">å®ç°äº’æ–¥çš„åŸºæœ¬å‡è®¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Atomic-Exchange-%E5%AE%9E%E7%8E%B0"><span class="toc-text">Atomic Exchange å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%EF%BC%9A%E5%81%9A%E9%A2%98%E5%AE%B6-v-s-%E7%A7%91%E5%AD%A6%E5%AE%B6"><span class="toc-text">å®ç°äº’æ–¥ï¼šåšé¢˜å®¶ v.s. ç§‘å­¦å®¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%EF%BC%9A%E8%87%AA%E6%97%8B%E9%94%81"><span class="toc-text">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BA%92%E6%96%A5%EF%BC%9A%E8%87%AA%E6%97%8B%E9%94%81-1"><span class="toc-text">å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E5%BC%BA%E5%A4%A7%E7%9A%84%E5%8E%9F%E5%AD%90%E6%8C%87%E4%BB%A4"><span class="toc-text">æ›´å¼ºå¤§çš„åŸå­æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%87%BA%E7%9A%84-Compare-%E7%94%A8%E5%A4%84"><span class="toc-text">å¤šå‡ºçš„ Compare: ç”¨å¤„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="toc-text">è‡ªæ—‹é”çš„ç¼ºé™·</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scalability-%E6%80%A7%E8%83%BD%E7%9A%84%E6%96%B0%E7%BB%B4%E5%BA%A6"><span class="toc-text">Scalability: æ€§èƒ½çš„æ–°ç»´åº¦</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">è‡ªæ—‹é”çš„ä½¿ç”¨åœºæ™¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B-%E9%95%BF%E4%B8%B4%E7%95%8C%E5%8C%BA%E7%9A%84%E4%BA%92%E6%96%A5"><span class="toc-text">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BA%BF%E7%A8%8B-%E9%95%BF%E4%B8%B4%E7%95%8C%E5%8C%BA%E7%9A%84%E4%BA%92%E6%96%A5-cont%E2%80%99d"><span class="toc-text">å®ç°çº¿ç¨‹ + é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥ (contâ€™d)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E4%BA%92%E6%96%A5%E7%9A%84%E4%B8%80%E4%BA%9B%E5%88%86%E6%9E%90"><span class="toc-text">å…³äºäº’æ–¥çš„ä¸€äº›åˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E8%B0%83%E8%AF%95%E4%B9%8B%E5%89%8D"><span class="toc-text">å¼€å§‹è°ƒè¯•ä¹‹å‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%9B%B0%E9%9A%BE%E7%9A%84%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0"><span class="toc-text">è°ƒè¯•å›°éš¾çš„æ ¹æœ¬åŸå› </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA"><span class="toc-text">è°ƒè¯•ç†è®º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA-cont%E2%80%99d"><span class="toc-text">è°ƒè¯•ç†è®º (contâ€™d)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%A0%E4%BB%AC%E6%98%AF%E5%90%A6%E9%81%87%E5%88%B0%E8%BF%87%E4%BB%A5%E4%B8%8B%E4%BB%A4%E4%BA%BA%E6%8A%93%E7%8B%82%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%9F"><span class="toc-text">ä½ ä»¬æ˜¯å¦é‡åˆ°è¿‡ä»¥ä¸‹ä»¤äººæŠ“ç‹‚çš„æƒ…å†µï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%96%E7%95%8C%EF%BC%9A%E4%B8%80%E5%88%87%E7%9A%86%E5%8F%AF%E8%B0%83%E8%AF%95"><span class="toc-text">è®¡ç®—æœºä¸–ç•Œï¼šä¸€åˆ‡çš†å¯è°ƒè¯•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA"><span class="toc-text">ä½¿ç”¨è°ƒè¯•ç†è®º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GDB-%E5%85%A5%E9%97%A8"><span class="toc-text">GDB: å…¥é—¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA%EF%BC%9A%E5%BA%94%E7%94%A8-Again"><span class="toc-text">è°ƒè¯•ç†è®ºï¼šåº”ç”¨ (Again)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A8%8B%E5%9F%BA%E6%9C%AC%E5%87%86%E5%88%99%EF%BC%9A%E5%9B%9E%E9%A1%BE"><span class="toc-text">ç¼–ç¨‹åŸºæœ¬å‡†åˆ™ï¼šå›é¡¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%90%86%E8%AE%BA%E7%9A%84%E6%9C%80%E9%87%8D%E8%A6%81%E5%BA%94%E7%94%A8"><span class="toc-text">è°ƒè¯•ç†è®ºçš„æœ€é‡è¦åº”ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%EF%BC%9A%E7%BB%B4%E6%8A%A4%E7%88%B6%E4%BA%B2%E8%8A%82%E7%82%B9%E7%9A%84%E5%B9%B3%E8%A1%A1%E6%A0%91"><span class="toc-text">ä¾‹å­ï¼šç»´æŠ¤çˆ¶äº²èŠ‚ç‚¹çš„å¹³è¡¡æ ‘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A6%8F%E5%88%A9%EF%BC%9A%E6%9B%B4%E5%A4%9A%E7%9A%84%E6%96%AD%E8%A8%80"><span class="toc-text">ç¦åˆ©ï¼šæ›´å¤šçš„æ–­è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%EF%BC%9A%E4%B8%87%E8%83%BD%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6-M2"><span class="toc-text">æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½å¹¶è¡Œè®¡ç®—æ¡†æ¶ (M2)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%EF%BC%9A%E6%9B%B4%E5%8F%A4%E6%80%AA%E7%9A%84%E4%B9%A0%E9%A2%98-x2F-%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-text">æ¡ä»¶å˜é‡ï¼šæ›´å¤æ€ªçš„ä¹ é¢˜&#x2F;é¢è¯•é¢˜</span></a>
    </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header">
    <i 
      class="iconfont icon-wenzhang_huaban" 
      style="padding-right: 2px;">
    </i>Recent Posts
  </div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2023-07-29</div>
        <a href="/2023/07/29/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"><div class="recent-posts-item-content">æ“ä½œç³»ç»Ÿ</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2023-05-24</div>
        <a href="/2023/05/24/Ubuntu%E5%90%8C%E6%AD%A5%E6%96%87%E4%BB%B6%E5%88%B0Onedrive/"><div class="recent-posts-item-content">UbuntuåŒæ­¥æ–‡ä»¶åˆ°Onedrive</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-11-22</div>
        <a href="/2022/11/22/dfs-2/"><div class="recent-posts-item-content">dfs_2</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-11-16</div>
        <a href="/2022/11/16/DFS-map/"><div class="recent-posts-item-content">DFS_map</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
          </div>
        </div>
      </div>
    </div>
     
    <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>
          Copyright Â©
          
            2020
          
          
                - 
                2023
          
        </span>
        &nbsp;
        <a 
          href="/" 
          class="footer-link">
          è‡ªç•™åœ°
        </a>
      </div>
    </div>

    
      <div class="footer-dsc">
        
          Powered by
          <a 
            href="https://hexo.io/" 
            class="footer-link" 
            target="_blank" 
            rel="nofollow noopener noreferrer">
            &nbsp;Hexo
          </a>
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          Theme -
          <a 
            href="https://github.com/theme-kaze" 
            class="footer-link" 
            target="_blank"
            rel="nofollow noopener noreferrer">
            &nbsp;Kaze
          </a>
        
      </div>
    
    
    
    
</footer>
 
    
  <a 
    role="button" 
    id="scrollbutton" 
    class="basebutton" 
    aria-label="å›åˆ°é¡¶éƒ¨">
    <i class="iconfont icon-arrowleft button-icon"></i>
  </a>

<a 
  role="button" 
  id="menubutton"
  aria-label="menu button"
  class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a 
  role="button" 
  id="popbutton" 
  class="basebutton" 
  aria-label="æ§åˆ¶ä¸­å¿ƒ">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a 
  role="button" 
  id="darkbutton" 
  class="basebutton darkwidget" 
  aria-label="å¤œè‰²æ¨¡å¼">
  <i class="iconfont icon-weather button-icon"></i>
</a>
<a 
  role="button" 
  id="searchbutton" 
  class="basebutton searchwidget" 
  aria-label="æœç´¢">
  <i class="iconfont icon-search button-icon"></i>
</a> 
     
     
     
      <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img')
    var i
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a')
      wrapper.setAttribute('href', img[i].getAttribute('data-src'))
      wrapper.setAttribute('aria-label', 'illustration')
      wrapper.style.cssText =
        'width: 100%; display: flex; justify-content: center;'
      if (img[i].alt) wrapper.dataset.caption = img[i].alt
      wrapper.dataset.nolink = true
      img[i].before(wrapper)
      wrapper.append(img[i])
      var divWrap = document.createElement('div')
      divWrap.classList.add('gallery')
      wrapper.before(divWrap)
      divWrap.append(wrapper)
    }
    baguetteBox.run('.gallery')
  }
</script>
<script>
  loadScript(
    "/js/lib/lightbox/baguetteBox.min.js",
    addImgLayout
  )
</script>
 
     
     
    <script src="/js/main.js"></script> 
     
    
      <script>
        var addLazyload = function () {
          var observer = lozad('.lozad', {
            load: function (el) {
              el.srcset = el.getAttribute('data-src')
            },
            loaded: function (el) {
              el.classList.add('loaded')
            },
          })
          observer.observe()
        }
      </script>
      <script>
        loadScript('/js/lib/lozad.min.js', addLazyload)
      </script>
    
    <script src="//instant.page/5.1.0" type="module"
      integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
    
    
  </body>
</html>
